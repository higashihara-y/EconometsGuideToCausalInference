---
title: "差の差法の基礎"
format:
  html: 
    theme: journal
    highlight-style: pygments
    page-layout: full
number-sections: true
toc: true
toc-depth: 3
toc-location: left
code-fold: show
date: "最終更新: 2025-01-25"
---





# 2方向固定効果（TWFE）推定

参照： [因果推論の計量経済学（川口、澤田）：第9章　差の差法の基礎（第10章　差の差法とその周辺の発展的トピック）](https://github.com/keisemi/EconometriciansGuide_CausalInference/blob/main/main/difference_in_differences_TWFE.html)

## シミュレーションデータの生成

### 定数とパラメータの設定


::: {.cell layout-align="center"}

```{.r .cell-code}
N <- 1000  #個体数
T0 <- 4
T1 <- 6
T <- T0 + T1　#期間
```
:::



処置が処置群全体に同時に割り当てられるデザイン（の正規分布のパラメータ）


::: {.cell layout-align="center"}

```{.r .cell-code}
mean_tau_i_simul <- 0.05
sd_tau_i_simul <- 0.2
```
:::



処置群のなかで処置が段階的に割り当てられていくデザイン

（
※正規分布の絶対値に以下の効果量の乗数をかけたものを処置効果とし、処置割り当てのタイミングごとに異なる符号の効果を発生させる）


::: {.cell layout-align="center"}

```{.r .cell-code}
mean_tau_i_multi <- 0.1
sd_tau_i_multi <- 0.2

scale_5 <- 1
scale_6 <- -2.5
scale_7 <- -1.75
scale_8 <- -1
```
:::



### 同時割り当てデータの生成

※データ生成過程については参照サイトの記述を参照


::: {.cell layout-align="center"}

```{.r .cell-code}
set.seed(1)
df_design <- 
  generate_df_no_covariates(
    N = N,
    T = T,
    T0 = T0,
    mean_tau_i = mean_tau_i_simul,
    sd_tau_i = sd_tau_i_simul
  )
```
:::



生成した10期間の処置群平均処置効果の期間全体平均


::: {.cell layout-align="center"}

```{.r .cell-code}
att_pop <- 
  df_design %>% 
  dplyr::filter(time > T0) %>% 
  dplyr::pull(tau_t) %>% 
  unique()  #6つの処置期間それぞれのtau_tを抽出

att_pop <- 
  mean(att_pop) * mean_tau_i_simul

att_pop  #ATTの期間全体平均
```

::: {.cell-output .cell-output-stdout}

```
[1] 0.04810142
```


:::
:::



処置期間ごとのATTの平均値を取ったATTの「期間全体平均」は、本来知り得ない母集団におけるパラメータから算出した母集団のATTとは必ずしも一致しない。


::: {.cell layout-align="center"}

```{.r .cell-code}
att_sample <- 
  df_design %>% 
  dplyr::filter(
    time > T0,
    g_i == 1
  ) %>% 
  dplyr::summarise(
    att_sample = mean(tau_it)
  ) %>% 
  dplyr::pull(att_sample)

att_sample
```

::: {.cell-output .cell-output-stdout}

```
[1] 0.04869019
```


:::
:::



### 複数時点での処置発生データの生成

※データ生成過程については参照サイトの記述を参照


::: {.cell layout-align="center"}

```{.r .cell-code}
set.seed(1)

df_design_multiperiod <- 
  generate_df_multiperiod(
    N = N,
    T = T,
    T1 = T1,
    T0 = T0,
    diff_trend = FALSE,
    mean_tau_i = mean_tau_i_multi,
    sd_tau_i = sd_tau_i_multi,
    scale_5 = scale_5,
    scale_6 = scale_6,
    scale_7 = scale_7,
    scale_8 = scale_8
  )
```
:::



各コホートの割合は以下


::: {.cell layout-align="center"}

```{.r .cell-code}
df_design_multiperiod %>% 
  dplyr::group_by(group_i) %>% 
  dplyr::summarise(
    fraction = length(z_it) 
  ) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(
    fraction = fraction / sum(fraction)
  ) %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> group_i </th>
   <th style="text-align:right;"> fraction </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0.325 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.457 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 0.128 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:right;"> 0.042 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 0.048 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



各コホートの「期間平均」のATTを算出するため、まず時間効果の期待値の絶対値$|\tau_i|$を算出する。


::: {.cell layout-align="center"}

```{.r .cell-code}
mean_abs_tau_i <- 
  (
    mean_tau_i_multi + 
      sd_tau_i_multi * (
        dnorm((-mean_tau_i_multi) / sd_tau_i_multi)) / 
      (1 - pnorm((-mean_tau_i_multi) / sd_tau_i_multi))
   ) * 
    pnorm(mean_tau_i_multi / sd_tau_i_multi) -
  (
    mean_tau_i_multi -
     sd_tau_i_multi * (
        dnorm((-mean_tau_i_multi) / sd_tau_i_multi)) / 
     (pnorm((-mean_tau_i_multi) / sd_tau_i_multi))
   ) * 
    (1 - pnorm(mean_tau_i_multi / sd_tau_i_multi))
```
:::



次にこの$\mathbb{E}[|\tau_i|]$をもとに、ATTの「期間平均」を算出する。


::: {.cell layout-align="center"}

```{.r .cell-code}
att_pop_multiperiod_group <- 
  df_design_multiperiod %>% 
  dplyr::filter(
    time > T0,
    g5_i == 1
  ) %>% 
  dplyr::summarise(
    group = "5",
    att_pop_multiperiod = 
      mean(unique(tau_t)) * scale_5 * mean_abs_tau_i,
    fraction_within_group = 
      sum(z_it) / sum(df_design_multiperiod$z_it)
  )

att_pop_multiperiod_group <- 
  rbind(
    att_pop_multiperiod_group,
    df_design_multiperiod %>% 
    dplyr::filter(
      time > T0 + 1,
      g6_i == 1
    ) %>% 
    dplyr::summarise(
      group = "6",
      att_pop_multiperiod = 
        mean(unique(tau_t)) * scale_6 * mean_abs_tau_i,
      fraction_within_group = 
        sum(z_it) / sum(df_design_multiperiod$z_it)
  ))

att_pop_multiperiod_group <- 
  rbind(
    att_pop_multiperiod_group,
    df_design_multiperiod %>% 
    dplyr::filter(
      time > T0 + 2,
      g7_i == 1
    ) %>% 
    dplyr::summarise(
      group = "7",
      att_pop_multiperiod = 
        mean(unique(tau_t)) * scale_7 * mean_abs_tau_i,
      fraction_within_group = 
        sum(z_it) / sum(df_design_multiperiod$z_it)
  ))

att_pop_multiperiod_group <- 
  rbind(
    att_pop_multiperiod_group,
    df_design_multiperiod %>% 
    dplyr::filter(
      time > T0 + 3,
      g8_i == 1
    ) %>% 
    dplyr::summarise(
      group = "8",
      att_pop_multiperiod = 
        mean(unique(tau_t)) * scale_8 * mean_abs_tau_i,
      fraction_within_group = 
        sum(z_it) / sum(df_design_multiperiod$z_it)
  ))

att_pop_multiperiod_group %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> group </th>
   <th style="text-align:right;"> att_pop_multiperiod </th>
   <th style="text-align:right;"> fraction_within_group </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 5 </td>
   <td style="text-align:right;"> 0.1742292 </td>
   <td style="text-align:right;"> 0.7422848 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 6 </td>
   <td style="text-align:right;"> -0.4407960 </td>
   <td style="text-align:right;"> 0.1732539 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 7 </td>
   <td style="text-align:right;"> -0.3071599 </td>
   <td style="text-align:right;"> 0.0454792 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 8 </td>
   <td style="text-align:right;"> -0.1788831 </td>
   <td style="text-align:right;"> 0.0389821 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



それぞれのグループの割合について加重平均を取り、母集団におけるATTの期間平均を算出。


::: {.cell layout-align="center"}

```{.r .cell-code}
att_pop_multiperiod <- 
  att_pop_multiperiod_group$att_pop_multiperiod %*%
  att_pop_multiperiod_group$fraction_within_group

att_pop_multiperiod
```

::: {.cell-output .cell-output-stdout}

```
           [,1]
[1,] 0.03201543
```


:::

```{.r .cell-code}
# 上記は以下の計算と同じ（%*%が加重平均を返す）
# att_pop_multiperiod <-
#   att_pop_multiperiod_group$att_pop_multiperiod *
#   att_pop_multiperiod_group$fraction_within_group
# 
# sum(att_pop_multiperiod)
```
:::



本来知り得ない母集団におけるパラメータである`tau_i`と`tau_t`からの算出ではなく、標本の`tau_it`の値を直接使い各コホートのATTを計算すると、母集団におけるATTとは厳密には一致しない。


::: {.cell layout-align="center"}

```{.r .cell-code}
att_sample_multiperiod_group <- 
  df_design_multiperiod %>% 
  dplyr::filter(
    group_i > 0
  ) %>% 
  dplyr::group_by(
    group_i
  ) %>% 
  dplyr::summarise(
    att_sample = sum(tau_it * (time >= group_i)) / sum(time >= group_i)
  )

att_sample_multiperiod_group %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> group_i </th>
   <th style="text-align:right;"> att_sample </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.1818912 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> -0.4782172 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:right;"> -0.4059614 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> -0.1652985 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



標本の`tau_it`の値から全コホートのATTを算出。


::: {.cell layout-align="center"}

```{.r .cell-code}
att_sample_multiperiod <- 
  df_design_multiperiod %>% 
  dplyr::filter(
    z_it > 0
  ) %>% 
  dplyr::summarise(
    att_sample_multiperiod = mean(tau_it)
  ) %>% 
  dplyr::pull(att_sample_multiperiod)

att_sample_multiperiod
```

::: {.cell-output .cell-output-stdout}

```
[1] 0.02725558
```


:::
:::



## 分析と推計

### 同時割り当てにおける推定

先に生成した`df_design`のうち、実際に観測できる変数は以下。


::: {.cell layout-align="center"}

```{.r .cell-code}
df_design_observed <- 
  df_design %>% 
  dplyr::select(
    id, time, g_i, z_it, y_it
  )

head(df_design_observed) %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> id </th>
   <th style="text-align:right;"> time </th>
   <th style="text-align:left;"> g_i </th>
   <th style="text-align:right;"> z_it </th>
   <th style="text-align:right;"> y_it </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 5.568051 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 5.571438 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 5.298484 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 5.407974 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 5.409445 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 5.142685 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



<br>

<u>**1. 平均の差による差の差の推定**</u>

処置群の割合の算出


::: {.cell layout-align="center"}

```{.r .cell-code}
df_design_observed %>% 
  dplyr::pull(g_i) %>% 
  mean()
```

::: {.cell-output .cell-output-stdout}

```
[1] 0.399
```


:::
:::



事後期間の処置群と統制群の平均の差


::: {.cell layout-align="center"}

```{.r .cell-code}
post <- 
  df_design_observed %>% 
  dplyr::filter(
    time > T0
  ) %>% 
  dplyr::summarise(
    sum(y_it * g_i) / sum(g_i) - sum(y_it * (1 - g_i)) / sum(1 - g_i)
  ) %>% 
  dplyr::ungroup()

post
```

::: {.cell-output .cell-output-stdout}

```
# A tibble: 1 × 1
  `sum(y_it * g_i)/sum(g_i) - sum(y_it * (1 - g_i))/sum(1 - g_i)`
                                                            <dbl>
1                                                           0.106
```


:::
:::



事前期間の処置群と統制群の平均の差


::: {.cell layout-align="center"}

```{.r .cell-code}
pre <- 
  df_design_observed %>% 
  dplyr::filter(
    time <= T0
  ) %>% 
  dplyr::summarise(
    sum(y_it * g_i) / sum(g_i) - sum(y_it * (1 - g_i)) / sum(1 - g_i)
  ) %>% 
  dplyr::ungroup()

pre
```

::: {.cell-output .cell-output-stdout}

```
# A tibble: 1 × 1
  `sum(y_it * g_i)/sum(g_i) - sum(y_it * (1 - g_i))/sum(1 - g_i)`
                                                            <dbl>
1                                                          0.0593
```


:::
:::



差の差推定量のノンパラメトリックな算出


::: {.cell layout-align="center"}

```{.r .cell-code}
did <- post - pre
did
```

::: {.cell-output .cell-output-stdout}

```
  sum(y_it * g_i)/sum(g_i) - sum(y_it * (1 - g_i))/sum(1 - g_i)
1                                                    0.04699217
```


:::
:::



上記の差の差推定により得られた`did`0.0469922は、母集団におけるATTの期間全体平均`att_pop`0.0481014の不偏推定量となる。

<br>

<u>**2. TWFEによる差の差推定**</u>

個体固定効果と時間固定効果を入れたTWFE推定量の算出。

以下のモデルの最小二乗推定量を算出し、係数$\tau$をATTの推定量とする。

\begin{align}
Y_{it} = \mu_i + \theta_t + \tau Z_{it} + \epsilon_{it}
\end{align}



::: {.cell layout-align="center"}

```{.r .cell-code}
lsdv <- 
  plm::plm(
    formula = y_it ~ z_it,
    data = df_design_observed,
    index = c("id", "time"),
    effect = "twoways"
  )

clubSandwich::coef_test(
  lsdv,
  vcov = "CR1",
  cluster = "id",
  test = "naive-t"
) %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output .cell-output-stderr}

```
Registered S3 method overwritten by 'clubSandwich':
  method    from    
  bread.mlm sandwich
```


:::

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:left;"> Coef </th>
   <th style="text-align:right;"> beta </th>
   <th style="text-align:right;"> SE </th>
   <th style="text-align:right;"> tstat </th>
   <th style="text-align:right;"> df_t </th>
   <th style="text-align:right;"> p_t </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> z_it </td>
   <td style="text-align:left;"> z_it </td>
   <td style="text-align:right;"> 0.0469922 </td>
   <td style="text-align:right;"> 0.0101817 </td>
   <td style="text-align:right;"> 4.615346 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 4.4e-06 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



<br>

**（参考）`estimatr::lm_robust`による推計**
`fixed_effects`に`id + time`、`clusters`に`id`、`se_type`に`CR0`を指定することで、同じ推計結果が得られる。


::: {.cell layout-align="center"}

```{.r .cell-code}
estimatr::lm_robust(
  formula = y_it ~ z_it,
  data = df_design_observed,
  fixed_effects = id + time,
  clusters = id,
  se_type = "CR0"
) %>% 
  summary() %>% 
  .$coefficients %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:right;"> Estimate </th>
   <th style="text-align:right;"> Std. Error </th>
   <th style="text-align:right;"> t value </th>
   <th style="text-align:right;"> Pr(&gt;|t|) </th>
   <th style="text-align:right;"> CI Lower </th>
   <th style="text-align:right;"> CI Upper </th>
   <th style="text-align:right;"> DF </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> z_it </td>
   <td style="text-align:right;"> 0.0469922 </td>
   <td style="text-align:right;"> 0.0101766 </td>
   <td style="text-align:right;"> 4.617655 </td>
   <td style="text-align:right;"> 4.4e-06 </td>
   <td style="text-align:right;"> 0.0270221 </td>
   <td style="text-align:right;"> 0.0669622 </td>
   <td style="text-align:right;"> 999 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



<br>

### 複数時点割り当てにおける推定

先に生成した`df_design_multiperiod`のうち、観測できる変数は以下。


::: {.cell layout-align="center"}

```{.r .cell-code}
df_design_multiperiod_observed <- 
  df_design_multiperiod %>% 
  dplyr::select(
    c("id",
      "time",
      "group_i",
      "g5_i",
      "g6_i",
      "g7_i",
      "g8_i",
      "z5_it",
      "z6_it",
      "z7_it",
      "z8_it",
      "z_it",
      "y_it")
  )

head(df_design_multiperiod_observed) %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> id </th>
   <th style="text-align:right;"> time </th>
   <th style="text-align:right;"> group_i </th>
   <th style="text-align:left;"> g5_i </th>
   <th style="text-align:left;"> g6_i </th>
   <th style="text-align:left;"> g7_i </th>
   <th style="text-align:left;"> g8_i </th>
   <th style="text-align:right;"> z5_it </th>
   <th style="text-align:right;"> z6_it </th>
   <th style="text-align:right;"> z7_it </th>
   <th style="text-align:right;"> z8_it </th>
   <th style="text-align:right;"> z_it </th>
   <th style="text-align:right;"> y_it </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 5.428205 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 5.539145 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 5.413548 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 5.236601 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 5.402495 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:left;"> TRUE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:left;"> FALSE </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 5.651068 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



<br>

<u>**1.平均の差による差の差の差推定**</u>

処置群を処置を受けたタイミングごとのグループgroup_iに分け、ずっと処置を受けない (never treated) 統制群と比較することによる差の差法推定。


::: {.cell layout-align="center"}

```{.r .cell-code}
trend_control <- 
  tibble::tibble(
    group_i = c(5, 6, 7, 8),
    trend_control = 
      df_design_multiperiod_observed %>% 
      dplyr::filter(
        group_i == 0
      ) %>% 
      dplyr::summarise(
        trend_5 = 
          sum(y_it * (time >= 5)) / sum(time >= 5) -
          sum(y_it * (time < 5)) / sum(time < 5),
        trend_6 = 
          sum(y_it * (time >= 6)) / sum(time >= 6) -
          sum(y_it * (time < 6)) / sum(time < 6),
        trend_7 = 
          sum(y_it * (time >= 7)) / sum(time >= 7) -
          sum(y_it * (time < 7)) / sum(time < 7),
        trend_8 = 
          sum(y_it * (time >= 8)) / sum(time >= 8) -
          sum(y_it * (time < 8)) / sum(time < 8)
      ) 
  ) 

trend_treated <- 
  df_design_multiperiod_observed %>% 
  dplyr::filter(
    group_i > 0
  ) %>% 
  dplyr::group_by(
    group_i
    ) %>% 
  dplyr::summarise(
    trend_treated =
      sum(y_it * (time >= group_i)) / sum(time >= group_i) -
      sum(y_it * (time < group_i)) / sum(time < group_i),
    proportion = sum(z_it) / sum(df_design_multiperiod$z_it)
  )

df_did <- 
  dplyr::left_join(
    trend_control,
    trend_treated,
    by = "group_i"
  )

df_did <- 
  df_did %>% 
  dplyr::mutate(
    did_dif = trend_treated - trend_control
  ) %>% 
  dplyr::select(
    group_i,
    did_dif,
    proportion
  )

df_did <-  
  df_did %>% 
  dplyr::left_join(
    att_sample_multiperiod_group,
    by = "group_i"
  )

df_did %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> group_i </th>
   <th style="text-align:left;"> did_dif </th>
   <th style="text-align:right;"> proportion </th>
   <th style="text-align:right;"> att_sample </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:left;"> 0.1846163 </td>
   <td style="text-align:right;"> 0.7422848 </td>
   <td style="text-align:right;"> 0.1818912 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:left;"> -0.4777081 </td>
   <td style="text-align:right;"> 0.1732539 </td>
   <td style="text-align:right;"> -0.4782172 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:left;"> -0.4050334 </td>
   <td style="text-align:right;"> 0.0454792 </td>
   <td style="text-align:right;"> -0.4059614 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:left;"> -0.1628867 </td>
   <td style="text-align:right;"> 0.0389821 </td>
   <td style="text-align:right;"> -0.1652985 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



これらの推定の加重平均を取り、ATTの期間全体平均を算出。


::: {.cell layout-align="center"}

```{.r .cell-code}
cbind(
  df_did %>% 
    dplyr::summarise(
      did_dif_average = sum(did_dif * proportion)
    ),
  att_sample_multiperiod
) %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> did_dif_average </th>
   <th style="text-align:right;"> att_sample_multiperiod </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0.1206256 </td>
   <td style="text-align:right;"> 0.0272556 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



<br>

<u>**2.TWFEによる誤った推定**</u>

以下のようなTWFEモデルの推定は、処置群全体でのATTをうまく推定できず、負の値を取る。

\begin{align}
Y_{it} = \mu_i + \theta_t + \tau Z_{it} + \epsilon_{it}
\end{align}



::: {.cell layout-align="center"}

```{.r .cell-code}
lsdv <- 
  plm::plm(
    formula = y_it ~ z_it,
    data = df_design_multiperiod_observed,
    index = c("id", "time"),
    effect = "twoways"
  )

lsdv %>% 
  clubSandwich::coef_test(
    vcov = "CR1",
    cluster = "id",
    test = "naive-t"
  ) %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:left;"> Coef </th>
   <th style="text-align:right;"> beta </th>
   <th style="text-align:right;"> SE </th>
   <th style="text-align:right;"> tstat </th>
   <th style="text-align:right;"> df_t </th>
   <th style="text-align:right;"> p_t </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> z_it </td>
   <td style="text-align:left;"> z_it </td>
   <td style="text-align:right;"> -0.0316089 </td>
   <td style="text-align:right;"> 0.0129085 </td>
   <td style="text-align:right;"> -2.44868 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0.0145091 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



<br>

**（参考）`estimatr::lm_robust`による推計**


::: {.cell layout-align="center"}

```{.r .cell-code}
estimatr::lm_robust(
  formula = y_it ~ z_it,
  data = df_design_multiperiod_observed,
  fixed_effects = id + time,
  clusters = id,
  se_type = "CR0"
) %>% 
  summary() %>%
  .$coefficients %>%
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:right;"> Estimate </th>
   <th style="text-align:right;"> Std. Error </th>
   <th style="text-align:right;"> t value </th>
   <th style="text-align:right;"> Pr(&gt;|t|) </th>
   <th style="text-align:right;"> CI Lower </th>
   <th style="text-align:right;"> CI Upper </th>
   <th style="text-align:right;"> DF </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> z_it </td>
   <td style="text-align:right;"> -0.0316089 </td>
   <td style="text-align:right;"> 0.0129021 </td>
   <td style="text-align:right;"> -2.449905 </td>
   <td style="text-align:right;"> 0.0144601 </td>
   <td style="text-align:right;"> -0.0569272 </td>
   <td style="text-align:right;"> -0.0062906 </td>
   <td style="text-align:right;"> 999 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



<br>

<u>**3.Goodman-baconによる分解**</u>



::: {.cell layout-align="center"}

```{.r .cell-code}
result <- 
  bacondecomp::bacon(
    formula = y_it ~ z_it,
    data = df_design_multiperiod_observed,
    id_var = "id",
    time_var = "time"
  )
```

::: {.cell-output .cell-output-stdout}

```
                      type  weight  avg_est
1 Earlier vs Later Treated 0.11180  0.09151
2 Later vs Earlier Treated 0.10536 -0.36396
3     Treated vs Untreated 0.78284 -0.00446
```


:::
:::

::: {.cell layout-align="center"}

```{.r .cell-code}
result %>% 
  ggplot() +
  aes(
    x = weight,
    y = estimate,
    colour = factor(type)
  ) +
  geom_point() +
  scale_color_viridis_d() +
  labs(
    color = "type"
  ) +
  theme(legend.position = "bottom")
```

::: {.cell-output-display}
![](第9章_files/figure-html/unnamed-chunk-27-1.png){fig-align='center' width=672}
:::
:::



必ずしもATTと解釈できない`Later vs Earlier Treated`の推定が負の値を取り、この不適切な比較に加重が与えられることによって、母集団におけるATTの期間平均0.0320154と大きく乖離した推計となっている。

<br>

<u>**4.修正TWFE推定**</u>

処置時点での層別を適切に行った、処置を受け始めるタイミングのグループと処置期間の時点について飽和した回帰（処置タイミングのコーホートダミー、時点ダミー、それらの処置時点に対応する交差項をすべて入れた回帰）を行う。

※回帰の詳細、フォーミュラについては参照サイトを参照。



::: {.cell layout-align="center"}

```{.r .cell-code}
df_design_multiperiod_observed$z_it_t <- 
  df_design_multiperiod_observed$z_it * 
  df_design_multiperiod_observed$time +
  df_design_multiperiod_observed$z_it *
  df_design_multiperiod_observed$group_i * 100

df_design_multiperiod_observed <- 
  fastDummies::dummy_cols(
    df_design_multiperiod_observed,
    select_columns = "z_it_t"
  )

df_design_multiperiod_observed <- 
  df_design_multiperiod_observed %>% 
  dplyr::select(-"z_it_t_0")

fml <- as.formula(
  paste("y_it ~ ",
        paste(grep(
          "z_it_t_",
          names(df_design_multiperiod_observed),
          value = TRUE
        ),
        collapse = "+"))
)

lsdv <- 
  plm::plm(
    formula = fml,
    data = df_design_multiperiod_observed,
    index = c("id", "time"),
    effect = "twoways"
  )

clubSandwich::coef_test(
  lsdv,
  vcov = "CR1",
  cluster = "id",
  test = "naive-t"
) %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">   </th>
   <th style="text-align:left;"> Coef </th>
   <th style="text-align:right;"> beta </th>
   <th style="text-align:right;"> SE </th>
   <th style="text-align:right;"> tstat </th>
   <th style="text-align:right;"> df_t </th>
   <th style="text-align:right;"> p_t </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> z_it_t_505 </td>
   <td style="text-align:left;"> z_it_t_505 </td>
   <td style="text-align:right;"> 0.1702083 </td>
   <td style="text-align:right;"> 0.0065098 </td>
   <td style="text-align:right;"> 26.146397 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_506 </td>
   <td style="text-align:left;"> z_it_t_506 </td>
   <td style="text-align:right;"> 0.1884960 </td>
   <td style="text-align:right;"> 0.0071110 </td>
   <td style="text-align:right;"> 26.507568 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_507 </td>
   <td style="text-align:left;"> z_it_t_507 </td>
   <td style="text-align:right;"> 0.1752558 </td>
   <td style="text-align:right;"> 0.0066062 </td>
   <td style="text-align:right;"> 26.529012 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_508 </td>
   <td style="text-align:left;"> z_it_t_508 </td>
   <td style="text-align:right;"> 0.1805536 </td>
   <td style="text-align:right;"> 0.0066972 </td>
   <td style="text-align:right;"> 26.959717 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_509 </td>
   <td style="text-align:left;"> z_it_t_509 </td>
   <td style="text-align:right;"> 0.1908563 </td>
   <td style="text-align:right;"> 0.0071104 </td>
   <td style="text-align:right;"> 26.841821 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_510 </td>
   <td style="text-align:left;"> z_it_t_510 </td>
   <td style="text-align:right;"> 0.2040676 </td>
   <td style="text-align:right;"> 0.0076521 </td>
   <td style="text-align:right;"> 26.668243 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_606 </td>
   <td style="text-align:left;"> z_it_t_606 </td>
   <td style="text-align:right;"> -0.4877827 </td>
   <td style="text-align:right;"> 0.0276891 </td>
   <td style="text-align:right;"> -17.616430 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_607 </td>
   <td style="text-align:left;"> z_it_t_607 </td>
   <td style="text-align:right;"> -0.4498325 </td>
   <td style="text-align:right;"> 0.0263777 </td>
   <td style="text-align:right;"> -17.053534 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_608 </td>
   <td style="text-align:left;"> z_it_t_608 </td>
   <td style="text-align:right;"> -0.4513963 </td>
   <td style="text-align:right;"> 0.0258310 </td>
   <td style="text-align:right;"> -17.474996 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_609 </td>
   <td style="text-align:left;"> z_it_t_609 </td>
   <td style="text-align:right;"> -0.4796776 </td>
   <td style="text-align:right;"> 0.0276876 </td>
   <td style="text-align:right;"> -17.324606 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_610 </td>
   <td style="text-align:left;"> z_it_t_610 </td>
   <td style="text-align:right;"> -0.5157074 </td>
   <td style="text-align:right;"> 0.0298698 </td>
   <td style="text-align:right;"> -17.265159 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_707 </td>
   <td style="text-align:left;"> z_it_t_707 </td>
   <td style="text-align:right;"> -0.3842658 </td>
   <td style="text-align:right;"> 0.0379974 </td>
   <td style="text-align:right;"> -10.112948 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_708 </td>
   <td style="text-align:left;"> z_it_t_708 </td>
   <td style="text-align:right;"> -0.3773633 </td>
   <td style="text-align:right;"> 0.0375526 </td>
   <td style="text-align:right;"> -10.048919 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_709 </td>
   <td style="text-align:left;"> z_it_t_709 </td>
   <td style="text-align:right;"> -0.4122213 </td>
   <td style="text-align:right;"> 0.0404317 </td>
   <td style="text-align:right;"> -10.195493 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_710 </td>
   <td style="text-align:left;"> z_it_t_710 </td>
   <td style="text-align:right;"> -0.4433033 </td>
   <td style="text-align:right;"> 0.0430448 </td>
   <td style="text-align:right;"> -10.298653 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_808 </td>
   <td style="text-align:left;"> z_it_t_808 </td>
   <td style="text-align:right;"> -0.1522525 </td>
   <td style="text-align:right;"> 0.0163056 </td>
   <td style="text-align:right;"> -9.337447 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_809 </td>
   <td style="text-align:left;"> z_it_t_809 </td>
   <td style="text-align:right;"> -0.1592979 </td>
   <td style="text-align:right;"> 0.0182895 </td>
   <td style="text-align:right;"> -8.709789 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> z_it_t_810 </td>
   <td style="text-align:left;"> z_it_t_810 </td>
   <td style="text-align:right;"> -0.1727879 </td>
   <td style="text-align:right;"> 0.0188303 </td>
   <td style="text-align:right;"> -9.176053 </td>
   <td style="text-align:right;"> 999 </td>
   <td style="text-align:right;"> 0 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



得られた係数について、処置タイミングのグループごとに集計。


::: {.cell layout-align="center"}

```{.r .cell-code}
df_compare <- 
  tibble::tibble(
    group_i = c(5, 6, 7, 8),
    did_lsdv = 
      c(
        mean(lsdv$coefficients[grep("z_it_t_5", names(lsdv$coefficients), value = TRUE)], na.rm = TRUE),
        mean(lsdv$coefficients[grep("z_it_t_6", names(lsdv$coefficients), value = TRUE)], na.rm = TRUE),
        mean(lsdv$coefficients[grep("z_it_t_7", names(lsdv$coefficients), value = TRUE)], na.rm = TRUE),
        mean(lsdv$coefficients[grep("z_it_t_8", names(lsdv$coefficients), value = TRUE)], na.rm = TRUE)
      ),
    did_dif = trend_treated$trend_treated - trend_control$trend_control[,1]
  )

df_compare %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> group_i </th>
   <th style="text-align:right;"> did_lsdv </th>
   <th style="text-align:left;"> did_dif </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 0.1849063 </td>
   <td style="text-align:left;"> 0.1846163 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> -0.4768793 </td>
   <td style="text-align:left;"> -0.4777081 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:right;"> -0.4042885 </td>
   <td style="text-align:left;"> -0.4050334 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> -0.1614461 </td>
   <td style="text-align:left;"> -0.1628867 </td>
  </tr>
</tbody>
</table>

`````
:::
:::



これらの値の加重平均を取ると、差の差法推定の推定値`did_dif_average`とおおむね一致する推定値を得る。（ただし、修正TWFE推定の回帰には、never-treatedのみならず、not-yet-treatedとの比較も一部含まれるため厳密には一致しない）



::: {.cell layout-align="center"}

```{.r .cell-code}
df_compare$proportion <- 
  df_did$proportion

df_compare %>% 
  dplyr::summarise(
    did_lsdv_average = sum(did_lsdv * proportion),
    did_dif_average = sum(did_dif[,1] * proportion)
  ) %>% 
  kbl() %>% 
  kable_styling()
```

::: {.cell-output-display}
`````{=html}
<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> did_lsdv_average </th>
   <th style="text-align:right;"> did_dif_average </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0.0299517 </td>
   <td style="text-align:right;"> 0.0295028 </td>
  </tr>
</tbody>
</table>

`````
:::
:::

