<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-01-28">

<title>差の差法の基礎</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="第9章_files/libs/clipboard/clipboard.min.js"></script>
<script src="第9章_files/libs/quarto-html/quarto.js"></script>
<script src="第9章_files/libs/quarto-html/popper.min.js"></script>
<script src="第9章_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="第9章_files/libs/quarto-html/anchor.min.js"></script>
<link href="第9章_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="第9章_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="第9章_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="第9章_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="第9章_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="第9章_files/libs/kePrint-0.0.1/kePrint.js"></script>

<link href="第9章_files/libs/lightable-0.0.1/lightable.css" rel="stylesheet">


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#方向固定効果twfe推定" id="toc-方向固定効果twfe推定" class="nav-link active" data-scroll-target="#方向固定効果twfe推定"><span class="header-section-number">1</span> 2方向固定効果（TWFE）推定</a>
  <ul class="collapse">
  <li><a href="#シミュレーションデータの生成" id="toc-シミュレーションデータの生成" class="nav-link" data-scroll-target="#シミュレーションデータの生成"><span class="header-section-number">1.1</span> シミュレーションデータの生成</a>
  <ul class="collapse">
  <li><a href="#定数とパラメータの設定" id="toc-定数とパラメータの設定" class="nav-link" data-scroll-target="#定数とパラメータの設定"><span class="header-section-number">1.1.1</span> 定数とパラメータの設定</a></li>
  <li><a href="#同時割り当てデータの生成" id="toc-同時割り当てデータの生成" class="nav-link" data-scroll-target="#同時割り当てデータの生成"><span class="header-section-number">1.1.2</span> 同時割り当てデータの生成</a></li>
  <li><a href="#複数時点での処置発生データの生成" id="toc-複数時点での処置発生データの生成" class="nav-link" data-scroll-target="#複数時点での処置発生データの生成"><span class="header-section-number">1.1.3</span> 複数時点での処置発生データの生成</a></li>
  </ul></li>
  <li><a href="#分析と推計" id="toc-分析と推計" class="nav-link" data-scroll-target="#分析と推計"><span class="header-section-number">1.2</span> 分析と推計</a>
  <ul class="collapse">
  <li><a href="#同時割り当てにおける推定" id="toc-同時割り当てにおける推定" class="nav-link" data-scroll-target="#同時割り当てにおける推定"><span class="header-section-number">1.2.1</span> 同時割り当てにおける推定</a></li>
  <li><a href="#複数時点割り当てにおける推定" id="toc-複数時点割り当てにおける推定" class="nav-link" data-scroll-target="#複数時点割り当てにおける推定"><span class="header-section-number">1.2.2</span> 複数時点割り当てにおける推定</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#合成コントロール法標準的デザインにおける推計" id="toc-合成コントロール法標準的デザインにおける推計" class="nav-link" data-scroll-target="#合成コントロール法標準的デザインにおける推計"><span class="header-section-number">2</span> 合成コントロール法：標準的デザインにおける推計</a>
  <ul class="collapse">
  <li><a href="#データの生成" id="toc-データの生成" class="nav-link" data-scroll-target="#データの生成"><span class="header-section-number">2.1</span> データの生成</a>
  <ul class="collapse">
  <li><a href="#定数とパラメータの設定-1" id="toc-定数とパラメータの設定-1" class="nav-link" data-scroll-target="#定数とパラメータの設定-1"><span class="header-section-number">2.1.1</span> 定数とパラメータの設定</a></li>
  <li><a href="#データの生成-1" id="toc-データの生成-1" class="nav-link" data-scroll-target="#データの生成-1"><span class="header-section-number">2.1.2</span> データの生成</a></li>
  </ul></li>
  <li><a href="#分析と推計-1" id="toc-分析と推計-1" class="nav-link" data-scroll-target="#分析と推計-1"><span class="header-section-number">2.2</span> 分析と推計</a>
  <ul class="collapse">
  <li><a href="#ファクターモデル処置効果がないケース" id="toc-ファクターモデル処置効果がないケース" class="nav-link" data-scroll-target="#ファクターモデル処置効果がないケース"><span class="header-section-number">2.2.1</span> ファクターモデル：処置効果がないケース</a></li>
  <li><a href="#ファクターモデル処置効果があるケース" id="toc-ファクターモデル処置効果があるケース" class="nav-link" data-scroll-target="#ファクターモデル処置効果があるケース"><span class="header-section-number">2.2.2</span> ファクターモデル：処置効果があるケース</a></li>
  <li><a href="#自己回帰モデルでの挙動処置効果がないケース" id="toc-自己回帰モデルでの挙動処置効果がないケース" class="nav-link" data-scroll-target="#自己回帰モデルでの挙動処置効果がないケース"><span class="header-section-number">2.2.3</span> 自己回帰モデルでの挙動：処置効果がないケース</a></li>
  <li><a href="#自己回帰モデルでの挙動処置効果があるケース" id="toc-自己回帰モデルでの挙動処置効果があるケース" class="nav-link" data-scroll-target="#自己回帰モデルでの挙動処置効果があるケース"><span class="header-section-number">2.2.4</span> 自己回帰モデルでの挙動：処置効果があるケース</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">差の差法の基礎</h1>
</div>



<div class="quarto-title-meta column-page-right">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 28, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="方向固定効果twfe推定" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> 2方向固定効果（TWFE）推定</h1>
<p>参照： <a href="https://github.com/keisemi/EconometriciansGuide_CausalInference/blob/main/main/difference_in_differences_TWFE.html">因果推論の計量経済学（川口、澤田）：第9章　差の差法の基礎（第10章　差の差法とその周辺の発展的トピック）</a></p>
<section id="シミュレーションデータの生成" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="シミュレーションデータの生成"><span class="header-section-number">1.1</span> シミュレーションデータの生成</h2>
<section id="定数とパラメータの設定" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="定数とパラメータの設定"><span class="header-section-number">1.1.1</span> 定数とパラメータの設定</h3>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span>  <span class="co">#個体数</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>T0 <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>T1 <span class="ot">&lt;-</span> <span class="dv">6</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>T <span class="ot">&lt;-</span> T0 <span class="sc">+</span> T1　<span class="co">#期間</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>処置が処置群全体に同時に割り当てられるデザイン（の正規分布のパラメータ）</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>mean_tau_i_simul <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>sd_tau_i_simul <span class="ot">&lt;-</span> <span class="fl">0.2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>処置群のなかで処置が段階的に割り当てられていくデザイン</p>
<p>（ ※正規分布の絶対値に以下の効果量の乗数をかけたものを処置効果とし、処置割り当てのタイミングごとに異なる符号の効果を発生させる）</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>mean_tau_i_multi <span class="ot">&lt;-</span> <span class="fl">0.1</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sd_tau_i_multi <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>scale_5 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>scale_6 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">2.5</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>scale_7 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">1.75</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>scale_8 <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="同時割り当てデータの生成" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="同時割り当てデータの生成"><span class="header-section-number">1.1.2</span> 同時割り当てデータの生成</h3>
<p>※データ生成過程については参照サイトの記述を参照</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df_design <span class="ot">&lt;-</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">generate_df_no_covariates</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> N,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">T =</span> T,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">T0 =</span> T0,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_tau_i =</span> mean_tau_i_simul,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_tau_i =</span> sd_tau_i_simul</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>生成した10期間の処置群平均処置効果の期間全体平均</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>att_pop <span class="ot">&lt;-</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  df_design <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(time <span class="sc">&gt;</span> T0) <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(tau_t) <span class="sc">%&gt;%</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()  <span class="co">#6つの処置期間それぞれのtau_tを抽出</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>att_pop <span class="ot">&lt;-</span> </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(att_pop) <span class="sc">*</span> mean_tau_i_simul</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>att_pop  <span class="co">#ATTの期間全体平均</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.04810142</code></pre>
</div>
</div>
<p>処置期間ごとのATTの平均値を取ったATTの「期間全体平均」は、本来知り得ない母集団におけるパラメータから算出した母集団のATTとは必ずしも一致しない。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>att_sample <span class="ot">&lt;-</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  df_design <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    time <span class="sc">&gt;</span> T0,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    g_i <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">att_sample =</span> <span class="fu">mean</span>(tau_it)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(att_sample)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>att_sample</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.04869019</code></pre>
</div>
</div>
</section>
<section id="複数時点での処置発生データの生成" class="level3" data-number="1.1.3">
<h3 data-number="1.1.3" class="anchored" data-anchor-id="複数時点での処置発生データの生成"><span class="header-section-number">1.1.3</span> 複数時点での処置発生データの生成</h3>
<p>※データ生成過程については参照サイトの記述を参照</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>df_design_multiperiod <span class="ot">&lt;-</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">generate_df_multiperiod</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">N =</span> N,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">T =</span> T,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">T1 =</span> T1,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">T0 =</span> T0,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">diff_trend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_tau_i =</span> mean_tau_i_multi,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd_tau_i =</span> sd_tau_i_multi,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale_5 =</span> scale_5,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale_6 =</span> scale_6,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale_7 =</span> scale_7,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale_8 =</span> scale_8</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>各コホートの割合は以下</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>df_design_multiperiod <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(group_i) <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fraction =</span> <span class="fu">length</span>(z_it) </span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">fraction =</span> fraction <span class="sc">/</span> <span class="fu">sum</span>(fraction)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">group_i</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">fraction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.325</td>
</tr>
<tr class="even">
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.457</td>
</tr>
<tr class="odd">
<td style="text-align: right;">6</td>
<td style="text-align: right;">0.128</td>
</tr>
<tr class="even">
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.042</td>
</tr>
<tr class="odd">
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.048</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>各コホートの「期間平均」のATTを算出するため、まず時間効果の期待値の絶対値<span class="math inline">\(|\tau_i|\)</span>を算出する。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>mean_abs_tau_i <span class="ot">&lt;-</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  (</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    mean_tau_i_multi <span class="sc">+</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>      sd_tau_i_multi <span class="sc">*</span> (</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dnorm</span>((<span class="sc">-</span>mean_tau_i_multi) <span class="sc">/</span> sd_tau_i_multi)) <span class="sc">/</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>      (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>((<span class="sc">-</span>mean_tau_i_multi) <span class="sc">/</span> sd_tau_i_multi))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>   ) <span class="sc">*</span> </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pnorm</span>(mean_tau_i_multi <span class="sc">/</span> sd_tau_i_multi) <span class="sc">-</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  (</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    mean_tau_i_multi <span class="sc">-</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>     sd_tau_i_multi <span class="sc">*</span> (</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dnorm</span>((<span class="sc">-</span>mean_tau_i_multi) <span class="sc">/</span> sd_tau_i_multi)) <span class="sc">/</span> </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>     (<span class="fu">pnorm</span>((<span class="sc">-</span>mean_tau_i_multi) <span class="sc">/</span> sd_tau_i_multi))</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>   ) <span class="sc">*</span> </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">-</span> <span class="fu">pnorm</span>(mean_tau_i_multi <span class="sc">/</span> sd_tau_i_multi))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>次にこの<span class="math inline">\(\mathbb{E}[|\tau_i|]\)</span>をもとに、ATTの「期間平均」を算出する。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>att_pop_multiperiod_group <span class="ot">&lt;-</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  df_design_multiperiod <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    time <span class="sc">&gt;</span> T0,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    g5_i <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> <span class="st">"5"</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">att_pop_multiperiod =</span> </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mean</span>(<span class="fu">unique</span>(tau_t)) <span class="sc">*</span> scale_5 <span class="sc">*</span> mean_abs_tau_i,</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">fraction_within_group =</span> </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(z_it) <span class="sc">/</span> <span class="fu">sum</span>(df_design_multiperiod<span class="sc">$</span>z_it)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>att_pop_multiperiod_group <span class="ot">&lt;-</span> </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    att_pop_multiperiod_group,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    df_design_multiperiod <span class="sc">%&gt;%</span> </span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>      time <span class="sc">&gt;</span> T0 <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>      g6_i <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> <span class="st">"6"</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">att_pop_multiperiod =</span> </span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(<span class="fu">unique</span>(tau_t)) <span class="sc">*</span> scale_6 <span class="sc">*</span> mean_abs_tau_i,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">fraction_within_group =</span> </span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(z_it) <span class="sc">/</span> <span class="fu">sum</span>(df_design_multiperiod<span class="sc">$</span>z_it)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>att_pop_multiperiod_group <span class="ot">&lt;-</span> </span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    att_pop_multiperiod_group,</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    df_design_multiperiod <span class="sc">%&gt;%</span> </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>      time <span class="sc">&gt;</span> T0 <span class="sc">+</span> <span class="dv">2</span>,</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>      g7_i <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> <span class="st">"7"</span>,</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">att_pop_multiperiod =</span> </span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(<span class="fu">unique</span>(tau_t)) <span class="sc">*</span> scale_7 <span class="sc">*</span> mean_abs_tau_i,</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">fraction_within_group =</span> </span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(z_it) <span class="sc">/</span> <span class="fu">sum</span>(df_design_multiperiod<span class="sc">$</span>z_it)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>att_pop_multiperiod_group <span class="ot">&lt;-</span> </span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    att_pop_multiperiod_group,</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    df_design_multiperiod <span class="sc">%&gt;%</span> </span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>      time <span class="sc">&gt;</span> T0 <span class="sc">+</span> <span class="dv">3</span>,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>      g8_i <span class="sc">==</span> <span class="dv">1</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> <span class="st">"8"</span>,</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">att_pop_multiperiod =</span> </span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(<span class="fu">unique</span>(tau_t)) <span class="sc">*</span> scale_8 <span class="sc">*</span> mean_abs_tau_i,</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>      <span class="at">fraction_within_group =</span> </span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(z_it) <span class="sc">/</span> <span class="fu">sum</span>(df_design_multiperiod<span class="sc">$</span>z_it)</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>att_pop_multiperiod_group <span class="sc">%&gt;%</span> </span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">att_pop_multiperiod</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">fraction_within_group</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: right;">0.1742292</td>
<td style="text-align: right;">0.7422848</td>
</tr>
<tr class="even">
<td style="text-align: left;">6</td>
<td style="text-align: right;">-0.4407960</td>
<td style="text-align: right;">0.1732539</td>
</tr>
<tr class="odd">
<td style="text-align: left;">7</td>
<td style="text-align: right;">-0.3071599</td>
<td style="text-align: right;">0.0454792</td>
</tr>
<tr class="even">
<td style="text-align: left;">8</td>
<td style="text-align: right;">-0.1788831</td>
<td style="text-align: right;">0.0389821</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>それぞれのグループの割合について加重平均を取り、母集団におけるATTの期間平均を算出。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>att_pop_multiperiod <span class="ot">&lt;-</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  att_pop_multiperiod_group<span class="sc">$</span>att_pop_multiperiod <span class="sc">%*%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  att_pop_multiperiod_group<span class="sc">$</span>fraction_within_group</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>att_pop_multiperiod</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>           [,1]
[1,] 0.03201543</code></pre>
</div>
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 上記は以下の計算と同じ（%*%が加重平均を返す）</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># att_pop_multiperiod &lt;-</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   att_pop_multiperiod_group$att_pop_multiperiod *</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   att_pop_multiperiod_group$fraction_within_group</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># sum(att_pop_multiperiod)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>本来知り得ない母集団におけるパラメータである<code>tau_i</code>と<code>tau_t</code>からの算出ではなく、標本の<code>tau_it</code>の値を直接使い各コホートのATTを計算すると、母集団におけるATTとは厳密には一致しない。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>att_sample_multiperiod_group <span class="ot">&lt;-</span> </span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  df_design_multiperiod <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    group_i <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    group_i</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">att_sample =</span> <span class="fu">sum</span>(tau_it <span class="sc">*</span> (time <span class="sc">&gt;=</span> group_i)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&gt;=</span> group_i)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>att_sample_multiperiod_group <span class="sc">%&gt;%</span> </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">group_i</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">att_sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.1818912</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">-0.4782172</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">-0.4059614</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">-0.1652985</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>標本の<code>tau_it</code>の値から全コホートのATTを算出。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>att_sample_multiperiod <span class="ot">&lt;-</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  df_design_multiperiod <span class="sc">%&gt;%</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    z_it <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">att_sample_multiperiod =</span> <span class="fu">mean</span>(tau_it)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(att_sample_multiperiod)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>att_sample_multiperiod</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.02725558</code></pre>
</div>
</div>
</section>
</section>
<section id="分析と推計" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="分析と推計"><span class="header-section-number">1.2</span> 分析と推計</h2>
<section id="同時割り当てにおける推定" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="同時割り当てにおける推定"><span class="header-section-number">1.2.1</span> 同時割り当てにおける推定</h3>
<p>先に生成した<code>df_design</code>のうち、実際に観測できる変数は以下。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df_design_observed <span class="ot">&lt;-</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  df_design <span class="sc">%&gt;%</span> </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    id, time, g_i, z_it, y_it</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_design_observed) <span class="sc">%&gt;%</span> </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">id</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">time</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">g_i</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z_it</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">y_it</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5.568051</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5.571438</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5.298484</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5.407974</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5.409445</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5.142685</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
<p><u><strong>1. 平均の差による差の差の推定</strong></u></p>
<p>処置群の割合の算出</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>df_design_observed <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(g_i) <span class="sc">%&gt;%</span> </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.399</code></pre>
</div>
</div>
<p>事後期間の処置群と統制群の平均の差</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>post <span class="ot">&lt;-</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  df_design_observed <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    time <span class="sc">&gt;</span> T0</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(y_it <span class="sc">*</span> g_i) <span class="sc">/</span> <span class="fu">sum</span>(g_i) <span class="sc">-</span> <span class="fu">sum</span>(y_it <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> g_i)) <span class="sc">/</span> <span class="fu">sum</span>(<span class="dv">1</span> <span class="sc">-</span> g_i)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>post</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  `sum(y_it * g_i)/sum(g_i) - sum(y_it * (1 - g_i))/sum(1 - g_i)`
                                                            &lt;dbl&gt;
1                                                           0.106</code></pre>
</div>
</div>
<p>事前期間の処置群と統制群の平均の差</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>pre <span class="ot">&lt;-</span> </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  df_design_observed <span class="sc">%&gt;%</span> </span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    time <span class="sc">&lt;=</span> T0</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(y_it <span class="sc">*</span> g_i) <span class="sc">/</span> <span class="fu">sum</span>(g_i) <span class="sc">-</span> <span class="fu">sum</span>(y_it <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> g_i)) <span class="sc">/</span> <span class="fu">sum</span>(<span class="dv">1</span> <span class="sc">-</span> g_i)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>()</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>pre</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  `sum(y_it * g_i)/sum(g_i) - sum(y_it * (1 - g_i))/sum(1 - g_i)`
                                                            &lt;dbl&gt;
1                                                          0.0593</code></pre>
</div>
</div>
<p>差の差推定量のノンパラメトリックな算出</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>did <span class="ot">&lt;-</span> post <span class="sc">-</span> pre</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>did</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  sum(y_it * g_i)/sum(g_i) - sum(y_it * (1 - g_i))/sum(1 - g_i)
1                                                    0.04699217</code></pre>
</div>
</div>
<p>上記の差の差推定により得られた<code>did</code>0.0469922は、母集団におけるATTの期間全体平均<code>att_pop</code>0.0481014の不偏推定量となる。</p>
<p><br></p>
<p><u><strong>2. TWFEによる差の差推定</strong></u></p>
<p>個体固定効果と時間固定効果を入れたTWFE推定量の算出。</p>
<p>以下のモデルの最小二乗推定量を算出し、係数<span class="math inline">\(\tau\)</span>をATTの推定量とする。</p>
<p><span class="math display">\[\begin{align}
Y_{it} = \mu_i + \theta_t + \tau Z_{it} + \epsilon_{it}
\end{align}\]</span></p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>lsdv <span class="ot">&lt;-</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  plm<span class="sc">::</span><span class="fu">plm</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y_it <span class="sc">~</span> z_it,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df_design_observed,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">effect =</span> <span class="st">"twoways"</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>clubSandwich<span class="sc">::</span><span class="fu">coef_test</span>(</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  lsdv,</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="st">"CR1"</span>,</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster =</span> <span class="st">"id"</span>,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">test =</span> <span class="st">"naive-t"</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 method overwritten by 'clubSandwich':
  method    from    
  bread.mlm sandwich</code></pre>
</div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Coef</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">beta</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">SE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">tstat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">df_t</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p_t</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">z_it</td>
<td style="text-align: left;">z_it</td>
<td style="text-align: right;">0.0469922</td>
<td style="text-align: right;">0.0101817</td>
<td style="text-align: right;">4.615346</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">4.4e-06</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
<p><strong>（参考）<code>estimatr::lm_robust</code>による推計</strong> <code>fixed_effects</code>に<code>id + time</code>、<code>clusters</code>に<code>id</code>、<code>se_type</code>に<code>CR0</code>を指定することで、同じ推計結果が得られる。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>estimatr<span class="sc">::</span><span class="fu">lm_robust</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> y_it <span class="sc">~</span> z_it,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_design_observed,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fixed_effects =</span> id <span class="sc">+</span> time,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">clusters =</span> id,</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">se_type =</span> <span class="st">"CR0"</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  .<span class="sc">$</span>coefficients <span class="sc">%&gt;%</span> </span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Std. Error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">t value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Pr(&gt;|t|)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CI Lower</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CI Upper</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">DF</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">z_it</td>
<td style="text-align: right;">0.0469922</td>
<td style="text-align: right;">0.0101766</td>
<td style="text-align: right;">4.617655</td>
<td style="text-align: right;">4.4e-06</td>
<td style="text-align: right;">0.0270221</td>
<td style="text-align: right;">0.0669622</td>
<td style="text-align: right;">999</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
</section>
<section id="複数時点割り当てにおける推定" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="複数時点割り当てにおける推定"><span class="header-section-number">1.2.2</span> 複数時点割り当てにおける推定</h3>
<p>先に生成した<code>df_design_multiperiod</code>のうち、観測できる変数は以下。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>df_design_multiperiod_observed <span class="ot">&lt;-</span> </span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  df_design_multiperiod <span class="sc">%&gt;%</span> </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"id"</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"time"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">"group_i"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>      <span class="st">"g5_i"</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>      <span class="st">"g6_i"</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"g7_i"</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"g8_i"</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"z5_it"</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">"z6_it"</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"z7_it"</span>,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"z8_it"</span>,</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">"z_it"</span>,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>      <span class="st">"y_it"</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(df_design_multiperiod_observed) <span class="sc">%&gt;%</span> </span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">id</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">time</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">group_i</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">g5_i</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">g6_i</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">g7_i</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">g8_i</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z5_it</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z6_it</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z7_it</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z8_it</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z_it</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">y_it</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5.428205</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5.539145</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5.413548</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5.236601</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5.402495</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">TRUE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">5.651068</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
<p><u><strong>1.平均の差による差の差の差推定</strong></u></p>
<p>処置群を処置を受けたタイミングごとのグループgroup_iに分け、ずっと処置を受けない (never treated) 統制群と比較することによる差の差法推定。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>trend_control <span class="ot">&lt;-</span> </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">group_i =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>),</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">trend_control =</span> </span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>      df_design_multiperiod_observed <span class="sc">%&gt;%</span> </span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>        group_i <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span> </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">trend_5 =</span> </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(y_it <span class="sc">*</span> (time <span class="sc">&gt;=</span> <span class="dv">5</span>)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&gt;=</span> <span class="dv">5</span>) <span class="sc">-</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(y_it <span class="sc">*</span> (time <span class="sc">&lt;</span> <span class="dv">5</span>)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&lt;</span> <span class="dv">5</span>),</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">trend_6 =</span> </span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(y_it <span class="sc">*</span> (time <span class="sc">&gt;=</span> <span class="dv">6</span>)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&gt;=</span> <span class="dv">6</span>) <span class="sc">-</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(y_it <span class="sc">*</span> (time <span class="sc">&lt;</span> <span class="dv">6</span>)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&lt;</span> <span class="dv">6</span>),</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">trend_7 =</span> </span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(y_it <span class="sc">*</span> (time <span class="sc">&gt;=</span> <span class="dv">7</span>)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&gt;=</span> <span class="dv">7</span>) <span class="sc">-</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(y_it <span class="sc">*</span> (time <span class="sc">&lt;</span> <span class="dv">7</span>)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&lt;</span> <span class="dv">7</span>),</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">trend_8 =</span> </span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(y_it <span class="sc">*</span> (time <span class="sc">&gt;=</span> <span class="dv">8</span>)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&gt;=</span> <span class="dv">8</span>) <span class="sc">-</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">sum</span>(y_it <span class="sc">*</span> (time <span class="sc">&lt;</span> <span class="dv">8</span>)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&lt;</span> <span class="dv">8</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>      ) </span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>trend_treated <span class="ot">&lt;-</span> </span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>  df_design_multiperiod_observed <span class="sc">%&gt;%</span> </span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    group_i <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>    group_i</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">trend_treated =</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(y_it <span class="sc">*</span> (time <span class="sc">&gt;=</span> group_i)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&gt;=</span> group_i) <span class="sc">-</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">sum</span>(y_it <span class="sc">*</span> (time <span class="sc">&lt;</span> group_i)) <span class="sc">/</span> <span class="fu">sum</span>(time <span class="sc">&lt;</span> group_i),</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">proportion =</span> <span class="fu">sum</span>(z_it) <span class="sc">/</span> <span class="fu">sum</span>(df_design_multiperiod<span class="sc">$</span>z_it)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>df_did <span class="ot">&lt;-</span> </span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>    trend_control,</span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>    trend_treated,</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"group_i"</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a>df_did <span class="ot">&lt;-</span> </span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a>  df_did <span class="sc">%&gt;%</span> </span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">did_dif =</span> trend_treated <span class="sc">-</span> trend_control</span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a>    group_i,</span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a>    did_dif,</span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a>    proportion</span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>df_did <span class="ot">&lt;-</span>  </span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>  df_did <span class="sc">%&gt;%</span> </span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>    att_sample_multiperiod_group,</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"group_i"</span></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>df_did <span class="sc">%&gt;%</span> </span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">group_i</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">did_dif</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">proportion</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">att_sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: left;">0.1846163</td>
<td style="text-align: right;">0.7422848</td>
<td style="text-align: right;">0.1818912</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: left;">-0.4777081</td>
<td style="text-align: right;">0.1732539</td>
<td style="text-align: right;">-0.4782172</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: left;">-0.4050334</td>
<td style="text-align: right;">0.0454792</td>
<td style="text-align: right;">-0.4059614</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: left;">-0.1628867</td>
<td style="text-align: right;">0.0389821</td>
<td style="text-align: right;">-0.1652985</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>これらの推定の加重平均を取り、ATTの期間全体平均を算出。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  df_did <span class="sc">%&gt;%</span> </span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">did_dif_average =</span> <span class="fu">sum</span>(did_dif <span class="sc">*</span> proportion)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  att_sample_multiperiod</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">did_dif_average</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">att_sample_multiperiod</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.1206256</td>
<td style="text-align: right;">0.0272556</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
<p><u><strong>2.TWFEによる誤った推定</strong></u></p>
<p>以下のようなTWFEモデルの推定は、処置群全体でのATTをうまく推定できず、負の値を取る。</p>
<p><span class="math display">\[\begin{align}
Y_{it} = \mu_i + \theta_t + \tau Z_{it} + \epsilon_{it}
\end{align}\]</span></p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>lsdv <span class="ot">&lt;-</span> </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  plm<span class="sc">::</span><span class="fu">plm</span>(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y_it <span class="sc">~</span> z_it,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df_design_multiperiod_observed,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">effect =</span> <span class="st">"twoways"</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>lsdv <span class="sc">%&gt;%</span> </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  clubSandwich<span class="sc">::</span><span class="fu">coef_test</span>(</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">vcov =</span> <span class="st">"CR1"</span>,</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">cluster =</span> <span class="st">"id"</span>,</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">test =</span> <span class="st">"naive-t"</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Coef</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">beta</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">SE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">tstat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">df_t</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p_t</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">z_it</td>
<td style="text-align: left;">z_it</td>
<td style="text-align: right;">-0.0316089</td>
<td style="text-align: right;">0.0129085</td>
<td style="text-align: right;">-2.44868</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0.0145091</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
<p><strong>（参考）<code>estimatr::lm_robust</code>による推計</strong></p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>estimatr<span class="sc">::</span><span class="fu">lm_robust</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">formula =</span> y_it <span class="sc">~</span> z_it,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_design_multiperiod_observed,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">fixed_effects =</span> id <span class="sc">+</span> time,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">clusters =</span> id,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">se_type =</span> <span class="st">"CR0"</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>() <span class="sc">%&gt;%</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  .<span class="sc">$</span>coefficients <span class="sc">%&gt;%</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Estimate</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Std. Error</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">t value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Pr(&gt;|t|)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CI Lower</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">CI Upper</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">DF</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">z_it</td>
<td style="text-align: right;">-0.0316089</td>
<td style="text-align: right;">0.0129021</td>
<td style="text-align: right;">-2.449905</td>
<td style="text-align: right;">0.0144601</td>
<td style="text-align: right;">-0.0569272</td>
<td style="text-align: right;">-0.0062906</td>
<td style="text-align: right;">999</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
<p><u><strong>3.Goodman-baconによる分解</strong></u></p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  bacondecomp<span class="sc">::</span><span class="fu">bacon</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y_it <span class="sc">~</span> z_it,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df_design_multiperiod_observed,</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_var =</span> <span class="st">"id"</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_var =</span> <span class="st">"time"</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                      type  weight  avg_est
1 Earlier vs Later Treated 0.11180  0.09151
2 Later vs Earlier Treated 0.10536 -0.36396
3     Treated vs Untreated 0.78284 -0.00446</code></pre>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>result <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> weight,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> estimate,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="fu">factor</span>(type)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"type"</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>必ずしもATTと解釈できない<code>Later vs Earlier Treated</code>の推定が負の値を取り、この不適切な比較に加重が与えられることによって、母集団におけるATTの期間平均0.0320154と大きく乖離した推計となっている。</p>
<p><br></p>
<p><u><strong>4.修正TWFE推定</strong></u></p>
<p>処置時点での層別を適切に行った、処置を受け始めるタイミングのグループと処置期間の時点について飽和した回帰（処置タイミングのコーホートダミー、時点ダミー、それらの処置時点に対応する交差項をすべて入れた回帰）を行う。</p>
<p>※回帰の詳細、フォーミュラについては参照サイトを参照。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>df_design_multiperiod_observed<span class="sc">$</span>z_it_t <span class="ot">&lt;-</span> </span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  df_design_multiperiod_observed<span class="sc">$</span>z_it <span class="sc">*</span> </span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  df_design_multiperiod_observed<span class="sc">$</span>time <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  df_design_multiperiod_observed<span class="sc">$</span>z_it <span class="sc">*</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  df_design_multiperiod_observed<span class="sc">$</span>group_i <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>df_design_multiperiod_observed <span class="ot">&lt;-</span> </span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  fastDummies<span class="sc">::</span><span class="fu">dummy_cols</span>(</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    df_design_multiperiod_observed,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">select_columns =</span> <span class="st">"z_it_t"</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>df_design_multiperiod_observed <span class="ot">&lt;-</span> </span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  df_design_multiperiod_observed <span class="sc">%&gt;%</span> </span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="st">"z_it_t_0"</span>)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>fml <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="st">"y_it ~ "</span>,</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">paste</span>(<span class="fu">grep</span>(</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>          <span class="st">"z_it_t_"</span>,</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">names</span>(df_design_multiperiod_observed),</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">value =</span> <span class="cn">TRUE</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">collapse =</span> <span class="st">"+"</span>))</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>lsdv <span class="ot">&lt;-</span> </span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  plm<span class="sc">::</span><span class="fu">plm</span>(</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> fml,</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> df_design_multiperiod_observed,</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">index =</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"time"</span>),</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">effect =</span> <span class="st">"twoways"</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>clubSandwich<span class="sc">::</span><span class="fu">coef_test</span>(</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>  lsdv,</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="st">"CR1"</span>,</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster =</span> <span class="st">"id"</span>,</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">test =</span> <span class="st">"naive-t"</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Coef</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">beta</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">SE</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">tstat</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">df_t</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">p_t</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">z_it_t_505</td>
<td style="text-align: left;">z_it_t_505</td>
<td style="text-align: right;">0.1702083</td>
<td style="text-align: right;">0.0065098</td>
<td style="text-align: right;">26.146397</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">z_it_t_506</td>
<td style="text-align: left;">z_it_t_506</td>
<td style="text-align: right;">0.1884960</td>
<td style="text-align: right;">0.0071110</td>
<td style="text-align: right;">26.507568</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">z_it_t_507</td>
<td style="text-align: left;">z_it_t_507</td>
<td style="text-align: right;">0.1752558</td>
<td style="text-align: right;">0.0066062</td>
<td style="text-align: right;">26.529012</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">z_it_t_508</td>
<td style="text-align: left;">z_it_t_508</td>
<td style="text-align: right;">0.1805536</td>
<td style="text-align: right;">0.0066972</td>
<td style="text-align: right;">26.959717</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">z_it_t_509</td>
<td style="text-align: left;">z_it_t_509</td>
<td style="text-align: right;">0.1908563</td>
<td style="text-align: right;">0.0071104</td>
<td style="text-align: right;">26.841821</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">z_it_t_510</td>
<td style="text-align: left;">z_it_t_510</td>
<td style="text-align: right;">0.2040676</td>
<td style="text-align: right;">0.0076521</td>
<td style="text-align: right;">26.668243</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">z_it_t_606</td>
<td style="text-align: left;">z_it_t_606</td>
<td style="text-align: right;">-0.4877827</td>
<td style="text-align: right;">0.0276891</td>
<td style="text-align: right;">-17.616430</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">z_it_t_607</td>
<td style="text-align: left;">z_it_t_607</td>
<td style="text-align: right;">-0.4498325</td>
<td style="text-align: right;">0.0263777</td>
<td style="text-align: right;">-17.053534</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">z_it_t_608</td>
<td style="text-align: left;">z_it_t_608</td>
<td style="text-align: right;">-0.4513963</td>
<td style="text-align: right;">0.0258310</td>
<td style="text-align: right;">-17.474996</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">z_it_t_609</td>
<td style="text-align: left;">z_it_t_609</td>
<td style="text-align: right;">-0.4796776</td>
<td style="text-align: right;">0.0276876</td>
<td style="text-align: right;">-17.324606</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">z_it_t_610</td>
<td style="text-align: left;">z_it_t_610</td>
<td style="text-align: right;">-0.5157074</td>
<td style="text-align: right;">0.0298698</td>
<td style="text-align: right;">-17.265159</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">z_it_t_707</td>
<td style="text-align: left;">z_it_t_707</td>
<td style="text-align: right;">-0.3842658</td>
<td style="text-align: right;">0.0379974</td>
<td style="text-align: right;">-10.112948</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">z_it_t_708</td>
<td style="text-align: left;">z_it_t_708</td>
<td style="text-align: right;">-0.3773633</td>
<td style="text-align: right;">0.0375526</td>
<td style="text-align: right;">-10.048919</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">z_it_t_709</td>
<td style="text-align: left;">z_it_t_709</td>
<td style="text-align: right;">-0.4122213</td>
<td style="text-align: right;">0.0404317</td>
<td style="text-align: right;">-10.195493</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">z_it_t_710</td>
<td style="text-align: left;">z_it_t_710</td>
<td style="text-align: right;">-0.4433033</td>
<td style="text-align: right;">0.0430448</td>
<td style="text-align: right;">-10.298653</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">z_it_t_808</td>
<td style="text-align: left;">z_it_t_808</td>
<td style="text-align: right;">-0.1522525</td>
<td style="text-align: right;">0.0163056</td>
<td style="text-align: right;">-9.337447</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">z_it_t_809</td>
<td style="text-align: left;">z_it_t_809</td>
<td style="text-align: right;">-0.1592979</td>
<td style="text-align: right;">0.0182895</td>
<td style="text-align: right;">-8.709789</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">z_it_t_810</td>
<td style="text-align: left;">z_it_t_810</td>
<td style="text-align: right;">-0.1727879</td>
<td style="text-align: right;">0.0188303</td>
<td style="text-align: right;">-9.176053</td>
<td style="text-align: right;">999</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>得られた係数について、処置タイミングのグループごとに集計。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>df_compare <span class="ot">&lt;-</span> </span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">group_i =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">did_lsdv =</span> </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">c</span>(</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(lsdv<span class="sc">$</span>coefficients[<span class="fu">grep</span>(<span class="st">"z_it_t_5"</span>, <span class="fu">names</span>(lsdv<span class="sc">$</span>coefficients), <span class="at">value =</span> <span class="cn">TRUE</span>)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(lsdv<span class="sc">$</span>coefficients[<span class="fu">grep</span>(<span class="st">"z_it_t_6"</span>, <span class="fu">names</span>(lsdv<span class="sc">$</span>coefficients), <span class="at">value =</span> <span class="cn">TRUE</span>)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(lsdv<span class="sc">$</span>coefficients[<span class="fu">grep</span>(<span class="st">"z_it_t_7"</span>, <span class="fu">names</span>(lsdv<span class="sc">$</span>coefficients), <span class="at">value =</span> <span class="cn">TRUE</span>)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(lsdv<span class="sc">$</span>coefficients[<span class="fu">grep</span>(<span class="st">"z_it_t_8"</span>, <span class="fu">names</span>(lsdv<span class="sc">$</span>coefficients), <span class="at">value =</span> <span class="cn">TRUE</span>)], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">did_dif =</span> trend_treated<span class="sc">$</span>trend_treated <span class="sc">-</span> trend_control<span class="sc">$</span>trend_control[,<span class="dv">1</span>]</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>df_compare <span class="sc">%&gt;%</span> </span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">group_i</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">did_lsdv</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">did_dif</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.1849063</td>
<td style="text-align: left;">0.1846163</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">-0.4768793</td>
<td style="text-align: left;">-0.4777081</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">-0.4042885</td>
<td style="text-align: left;">-0.4050334</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">-0.1614461</td>
<td style="text-align: left;">-0.1628867</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>これらの値の加重平均を取ると、差の差法推定の推定値<code>did_dif_average</code>とおおむね一致する推定値を得る。（ただし、修正TWFE推定の回帰には、never-treatedのみならず、not-yet-treatedとの比較も一部含まれるため厳密には一致しない）</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df_compare<span class="sc">$</span>proportion <span class="ot">&lt;-</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  df_did<span class="sc">$</span>proportion</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>df_compare <span class="sc">%&gt;%</span> </span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">summarise</span>(</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">did_lsdv_average =</span> <span class="fu">sum</span>(did_lsdv <span class="sc">*</span> proportion),</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">did_dif_average =</span> <span class="fu">sum</span>(did_dif[,<span class="dv">1</span>] <span class="sc">*</span> proportion)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">did_lsdv_average</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">did_dif_average</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">0.0299517</td>
<td style="text-align: right;">0.0295028</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
</section>
</section>
</section>
<section id="合成コントロール法標準的デザインにおける推計" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> 合成コントロール法：標準的デザインにおける推計</h1>
<p>参照：<a href="https://github.com/keisemi/EconometriciansGuide_CausalInference/blob/main/main/difference_in_differences_synthetic_control.html">因果推論の計量経済学（川口、澤田）：第9章　差の差法の基礎</a></p>
<p>処置群の数が限られる場合における手法としての合成コントロール法を、<code>tidysynth</code>パッケージを使い実装する。</p>
<p>分析には<code>tidysynth</code>パッケージに含まれる、<code>smoking</code>データを使う。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"smoking"</span>,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">package =</span> <span class="st">"tidysynth"</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>smoking <span class="sc">%&gt;%</span> </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    state                year         cigsale         lnincome     
 Length:1209        Min.   :1970   Min.   : 40.7   Min.   : 9.397  
 Class :character   1st Qu.:1977   1st Qu.:100.9   1st Qu.: 9.739  
 Mode  :character   Median :1985   Median :116.3   Median : 9.861  
                    Mean   :1985   Mean   :118.9   Mean   : 9.862  
                    3rd Qu.:1993   3rd Qu.:130.5   3rd Qu.: 9.973  
                    Max.   :2000   Max.   :296.2   Max.   :10.487  
                                                   NA's   :195     
      beer         age15to24         retprice    
 Min.   : 2.50   Min.   :0.1294   Min.   : 27.3  
 1st Qu.:20.90   1st Qu.:0.1658   1st Qu.: 50.0  
 Median :23.30   Median :0.1781   Median : 95.5  
 Mean   :23.43   Mean   :0.1755   Mean   :108.3  
 3rd Qu.:25.10   3rd Qu.:0.1867   3rd Qu.:158.4  
 Max.   :40.40   Max.   :0.2037   Max.   :351.2  
 NA's   :663     NA's   :390                     </code></pre>
</div>
</div>
<section id="データの生成" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="データの生成"><span class="header-section-number">2.1</span> データの生成</h2>
<section id="定数とパラメータの設定-1" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="定数とパラメータの設定-1"><span class="header-section-number">2.1.1</span> 定数とパラメータの設定</h3>
<p>仮想的な処置タイミングと処置群の設定。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>year_start <span class="ot">&lt;-</span> <span class="dv">1988</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>name_treated <span class="ot">&lt;-</span> <span class="st">"California"</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>year_init <span class="ot">&lt;-</span> <span class="fu">min</span>(smoking<span class="sc">$</span>year)</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>year_end <span class="ot">&lt;-</span> <span class="fu">max</span>(smoking<span class="sc">$</span>year)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>total_years <span class="ot">&lt;-</span> year_end <span class="sc">-</span> year_init</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 切片項</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>alpha0_retprice <span class="ot">&lt;-</span> <span class="dv">35</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>alpha0_cigsale <span class="ot">&lt;-</span> <span class="dv">140</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 時間効果パラメータ</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>delta_mean <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>delta_sd <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ファクターのパラメータ</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>mu_mean <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>mu_sd <span class="ot">&lt;-</span> <span class="dv">2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><code>cigsale</code>を減らす処置効果を決定するパラメータ</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>te_unif_lower <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>te_unif_upper <span class="ot">&lt;-</span> <span class="fl">0.1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>自己回帰モデルのパラメータ</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 誤差項分布パラメータ</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>eta_mean <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>eta_sd <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 自己回帰係数パラメータ</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.1</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>rho_zy <span class="ot">&lt;-</span> <span class="fl">0.01</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>rho_zz <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>rho_yy <span class="ot">&lt;-</span> <span class="fl">0.5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>合成コントロール法で合わせる期間の設定</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用する共変量と顕在結果の時点の設定</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>window_income_age <span class="ot">&lt;-</span> <span class="dv">1980</span><span class="sc">:</span><span class="dv">1988</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>window_beer <span class="ot">&lt;-</span> <span class="dv">1984</span><span class="sc">:</span><span class="dv">1988</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>window_cigsale1 <span class="ot">&lt;-</span> <span class="dv">1975</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>window_cigsale2 <span class="ot">&lt;-</span> <span class="dv">1980</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>window_cigsale3 <span class="ot">&lt;-</span> <span class="dv">1988</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ウェイトの計算に用いる期間の設定</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>window_fit <span class="ot">&lt;-</span> <span class="dv">1970</span><span class="sc">:</span><span class="dv">1988</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>最適化にあたって使用する、二次計画ソルバーに渡すチューニングパラメータの設定。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>margin_ipop <span class="ot">&lt;-</span> <span class="fl">0.02</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>sigf_ipop <span class="ot">&lt;-</span> <span class="dv">7</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>bound_ipop <span class="ot">&lt;-</span> <span class="dv">6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="データの生成-1" class="level3" data-number="2.1.2">
<h3 data-number="2.1.2" class="anchored" data-anchor-id="データの生成-1"><span class="header-section-number">2.1.2</span> データの生成</h3>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><u><strong>ファクターモデル：処置効果がないケース</strong></u></p>
<p><code>retprice</code>と<code>cigsale</code>が以下の位置変量ファクターモデルで生成でされていると想定。 共に平均0の乱数で生成し、処置効果が無い設定とする。</p>
<p><span class="math display">\[
Y_{it} = \alpha_0 + \delta_t + \lambda_t \mu_i + \epsilon_{it}
\]</span></p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>smoking_fake_factor_no_effect <span class="ot">&lt;-</span> </span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>  smoking <span class="sc">%&gt;%</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_i_retprice =</span> </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> mu_mean,</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> mu_sd),</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_i_cisale =</span> </span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> mu_mean,</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> mu_sd)</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span> </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">retprice =</span> </span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>      alpha0_retprice <span class="sc">+</span>                <span class="co"># 切片$\alpha_0$</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>,                    </span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> delta_mean,</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> delta_sd) <span class="sc">+</span>           <span class="co"># $delta_t$</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">*</span> mu_i_retprice <span class="sc">+</span>   <span class="co"># $\lambda_t \mu_i</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">length</span>(state)),        <span class="co"># $\eplison_{it}$</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">cigsale =</span> </span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a>      alpha0_cigsale <span class="sc">+</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> delta_mean,</span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> delta_sd) <span class="sc">+</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">*</span> mu_i_cisale <span class="sc">+</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">length</span>(state))</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>mu_i_retprice,</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>mu_i_cisale</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><br></p>
<p><u><strong>ファクターモデル：処置効果があるケース</strong></u></p>
<p>カリフォルニアでは処置期以降に販売量が減少する状況を想定したデータを生成。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>smoking_fake_factor_some_effect <span class="ot">&lt;-</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  smoking <span class="sc">%&gt;%</span> </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_i_retprice =</span> </span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> mu_mean,</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> mu_sd),</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_i_cigsale =</span> </span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> mu_mean,</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> mu_sd)</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span> </span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">retprice =</span> </span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>      alpha0_retprice <span class="sc">+</span>                <span class="co"># 切片$\alpha_0$</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>,                    </span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> delta_mean,</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> delta_sd) <span class="sc">+</span>           <span class="co"># $delta_t$</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">*</span> mu_i_retprice <span class="sc">+</span>   <span class="co"># $\lambda_t \mu_i</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">length</span>(state)),        <span class="co"># $\eplison_{it}$</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">cigsale =</span> </span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>      alpha0_cigsale <span class="sc">+</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">mean =</span> delta_mean,</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">sd =</span> delta_sd) <span class="sc">+</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">*</span> mu_i_cigsale <span class="sc">+</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rnorm</span>(<span class="at">n =</span> <span class="fu">length</span>(state))</span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>mu_i_retprice,</span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>mu_i_cigsale</span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">cigsale =</span> </span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ifelse</span>(</span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>        state <span class="sc">==</span> name_treated <span class="sc">&amp;</span> year <span class="sc">&gt;</span> year_start,</span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>        cigsale <span class="sc">*</span> (</span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>          <span class="dv">1</span> <span class="sc">-</span> <span class="fu">runif</span>(<span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>                    te_unif_lower,</span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>                    te_unif_upper)</span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>        cigsale</span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><br></p>
<p><u><strong>自己回帰モデル：処置効果がないケース</strong></u></p>
<p>時間を通じて一定の自己回帰係数<span class="math inline">\(\rho_{zz}\)</span>と<span class="math inline">\(\rho_{yy}\)</span>を持つ自己回帰モデルを想定したデータの生成。（モデルの詳細は参照サイトを参照）</p>
<p>※なお、参照サイトでは<code>year_start</code>を<code>year_init + 10</code>と計算しているが、定義上の<code>year_start</code>と一致しない。このようになっている理由は不明だが、以下では参照サイトの計算式に従う。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>smoking_fake <span class="ot">&lt;-</span> smoking</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">unique</span>(smoking_fake<span class="sc">$</span>year)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>smoking_fake<span class="sc">$</span>retprice[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  alpha0_retprice <span class="sc">+</span> </span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">sum</span>(smoking_fake<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> eta_mean,</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> eta_sd</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>smoking_fake<span class="sc">$</span>cigsale[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> </span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  alpha0_cigsale <span class="sc">+</span> </span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>  rho <span class="sc">*</span> smoking_fake<span class="sc">$</span>retprice[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">1</span>] <span class="sc">+</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">sum</span>(smoking_fake<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> eta_mean,</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> eta_sd</span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>  )  </span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>  t <span class="cf">in</span> years[<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(years)]</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>  smoking_fake<span class="sc">$</span>retprice[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t] <span class="ot">&lt;-</span> </span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>    alpha0_retprice <span class="sc">+</span> </span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>    rho_zy<span class="sc">*</span>(</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>      (t <span class="sc">-</span> (year_init <span class="sc">+</span> <span class="dv">10</span>)) <span class="sc">/</span> total_years</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> smoking_fake<span class="sc">$</span>cigsale[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>    rho_zz <span class="sc">*</span> (</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>      (t <span class="sc">-</span> year_init) <span class="sc">/</span> total_years</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">*</span> smoking_fake<span class="sc">$</span>retprice[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> </span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">sum</span>(smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t),</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> eta_mean,</span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> eta_sd</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>  smoking_fake<span class="sc">$</span>cigsale[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t] <span class="ot">&lt;-</span> </span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>    alpha0_cigsale <span class="sc">+</span> </span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>    rho <span class="sc">*</span> smoking_fake<span class="sc">$</span>retprice[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t] <span class="sc">+</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>    rho_yy <span class="sc">*</span> (</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>      (t <span class="sc">-</span> year_init) <span class="sc">/</span> total_years</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span> smoking_fake<span class="sc">$</span>cigsale[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> </span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(</span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">sum</span>(smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t),</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> eta_mean,</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> eta_sd</span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>    )  </span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>smoking_fake_ar_no_effect <span class="ot">&lt;-</span> smoking_fake</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><br></p>
<p><u><strong>自己回帰モデル：処置効果があるケース</strong></u></p>
<p>処置群のみ、処置発生の翌年以降、毎年比例的に減少する場合のデータを生成。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>smoking_fake <span class="ot">&lt;-</span> smoking</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">unique</span>(smoking_fake<span class="sc">$</span>year)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>smoking_fake<span class="sc">$</span>retprice[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  alpha0_retprice <span class="sc">+</span> </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">sum</span>(smoking_fake<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> eta_mean,</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> eta_sd</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>smoking_fake<span class="sc">$</span>cigsale[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">1</span>] <span class="ot">&lt;-</span> </span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>  alpha0_cigsale <span class="sc">+</span> </span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>  rho <span class="sc">*</span> smoking_fake<span class="sc">$</span>retprice[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">1</span>] <span class="sc">+</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rnorm</span>(</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">n =</span> <span class="fu">sum</span>(smoking_fake<span class="sc">$</span>year <span class="sc">==</span> <span class="dv">1</span>),</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> eta_mean,</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> eta_sd</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>  t <span class="cf">in</span> years[<span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(years)]</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>  smoking_fake<span class="sc">$</span>retprice[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t] <span class="ot">&lt;-</span> </span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>    alpha0_retprice <span class="sc">+</span> </span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>    rho_zy<span class="sc">*</span>((t <span class="sc">-</span> (year_init<span class="sc">+</span><span class="dv">10</span>))<span class="sc">/</span>total_years)<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    smoking_fake<span class="sc">$</span>cigsale[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>    rho_zz<span class="sc">*</span> ((t <span class="sc">-</span> year_init)<span class="sc">/</span>total_years) <span class="sc">*</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    smoking_fake<span class="sc">$</span>retprice[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> </span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">sum</span>(smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t),</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> eta_mean,</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> eta_sd</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>  smoking_fake<span class="sc">$</span>cigsale[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t] <span class="ot">&lt;-</span> </span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a>    alpha0_cigsale <span class="sc">+</span> </span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    rho <span class="sc">*</span> smoking_fake<span class="sc">$</span>retprice[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t] <span class="sc">+</span></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>    rho_yy <span class="sc">*</span> ((t <span class="sc">-</span> year_init)<span class="sc">/</span>total_years)<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>    smoking_fake<span class="sc">$</span>cigsale[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t <span class="sc">-</span> <span class="dv">1</span>] <span class="sc">+</span> </span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rnorm</span>(</span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">n =</span> <span class="fu">sum</span>(smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t),</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> eta_mean,</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> eta_sd</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>  smoking_fake<span class="sc">$</span>cigsale[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t <span class="sc">&amp;</span></span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>                         smoking_fake<span class="sc">$</span>state <span class="sc">==</span> <span class="st">'California'</span>] <span class="ot">&lt;-</span> </span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>    smoking_fake<span class="sc">$</span>cigsale[smoking_fake<span class="sc">$</span>year <span class="sc">==</span> t <span class="sc">&amp;</span></span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>                           smoking_fake<span class="sc">$</span>state <span class="sc">==</span> <span class="st">'California'</span>] <span class="sc">*</span> (</span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>      <span class="dv">1</span> <span class="sc">-</span> </span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">runif</span>(</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="dv">1</span>,</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a>        te_unif_lower,</span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>        te_unif_upper</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">*</span> (</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>        t <span class="sc">&gt;</span> year_start</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a>smoking_fake_ar_some_effect <span class="ot">&lt;-</span> smoking_fake</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="分析と推計-1" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="分析と推計-1"><span class="header-section-number">2.2</span> 分析と推計</h2>
<section id="ファクターモデル処置効果がないケース" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="ファクターモデル処置効果がないケース"><span class="header-section-number">2.2.1</span> ファクターモデル：処置効果がないケース</h3>
<p>関数の設定内容の詳細は参照サイトを参照。（以下、事前に定義した変数の再掲）</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 合成コントロール法で合わせる期間の設定</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ・使用する共変量と顕在結果の時点の設定</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># window_income_age &lt;- 1980:1988</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># window_beer &lt;- 1984:1988</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # window_cigsale1 &lt;- 1975</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="co"># # window_cigsale2 &lt;- 1980</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co"># # window_cigsale3 &lt;- 1988</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ・ウェイトの計算に用いる期間の設定</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="co"># window_fit &lt;- 1970:1988</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 最適化にあたって使用する、二次計画ソルバーに渡すチューニングパラメータの設定。</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="co"># margin_ipop &lt;- 0.02</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="co"># sigf_ipop &lt;- 7</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="co"># bound_ipop &lt;- 6</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect <span class="ot">&lt;-</span> </span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  smoking_fake_factor_no_effect <span class="sc">%&gt;%</span> </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">synthetic_control</span>(</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">outcome =</span> cigsale,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">unit =</span> state,</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> year,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">i_unit =</span> name_treated,</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">i_time =</span> year_start,</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">generate_placebos =</span> <span class="cn">TRUE</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">generate_predictor</span>(</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_window =</span> window_income_age,</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">lnincome =</span> <span class="fu">mean</span>(lnincome, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">youth =</span> <span class="fu">mean</span>(age15to24, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">generate_predictor</span>(</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_window =</span> window_beer,</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">beer_sales =</span> <span class="fu">mean</span>(beer, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">generate_predictor</span>(</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_window =</span> window_cigsale1,</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">cigsale1 =</span> cigsale</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">generate_predictor</span>(</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_window =</span> window_cigsale2,</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">cigsale2 =</span> cigsale</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">generate_predictor</span>(</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_window =</span> window_cigsale3,</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">cigsale3 =</span> cigsale</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">generate_weights</span>(</span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimization_window =</span> window_fit,</span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">margin_ipop =</span> margin_ipop,</span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigf_ipop =</span> sigf_ipop,</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">bound_ipop =</span> bound_ipop</span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">generate_control</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><u><strong>推定結果の表示</strong></u></p>
<p><code>plot_trends</code>で、合成コントロール系列と観測系列を比較するプロットを生成。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_trends</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>plot_differences</code>で、それらを差分として表示。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_differences</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>plot_weights</code>で、どの統制群とどの変数が予測に寄与しているかを表示。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_weights</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-47-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>grab_balance_table</code>で、予測に用いた変数の合成コントロールと実際の観測における類似の程度を表示。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">grab_balance_table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">California</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">synthetic_California</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">donor_sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lnincome</td>
<td style="text-align: right;">10.0765586</td>
<td style="text-align: right;">9.9507206</td>
<td style="text-align: right;">9.8291968</td>
</tr>
<tr class="even">
<td style="text-align: left;">youth</td>
<td style="text-align: right;">0.1735324</td>
<td style="text-align: right;">0.1730182</td>
<td style="text-align: right;">0.1725101</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beer_sales</td>
<td style="text-align: right;">24.2800003</td>
<td style="text-align: right;">28.5184480</td>
<td style="text-align: right;">23.6552632</td>
</tr>
<tr class="even">
<td style="text-align: left;">cigsale1</td>
<td style="text-align: right;">137.8555014</td>
<td style="text-align: right;">138.5129916</td>
<td style="text-align: right;">140.0848534</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cigsale2</td>
<td style="text-align: right;">135.9694223</td>
<td style="text-align: right;">135.8295657</td>
<td style="text-align: right;">136.4325736</td>
</tr>
<tr class="even">
<td style="text-align: left;">cigsale3</td>
<td style="text-align: right;">135.6485199</td>
<td style="text-align: right;">136.0652810</td>
<td style="text-align: right;">135.9853657</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
<p><u><strong>プラセボ分析と推測統計</strong></u></p>
<p>推計において<code>generate_placebos</code>をTRUEにすることで、統制群の各個体についても同様のウェイトが計算され、<code>plot_placebos</code>で全個体に対する予測と合成コントロール予測を可視化できる。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_placebos</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-49-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>prune = FALSE</code>とすることで、（予測がうまくいかず）自動で排除されていた個体も含む全ての個体を表示。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_placebos</span>(</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">prune =</span> <span class="cn">FALSE</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-50-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>plot_mspe_ratio</code>で、統制群のプラセボ予測誤差に比べて、処置群の予測誤差が 何番目に大きいかを表示。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_mspe_ratio</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-51-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><code>grab_significance</code>で、処置個体と他の全てのプラセボ個体が同じ予測誤差を持っている場合の帰無仮説において、特定の順位が生じる確率が<code>fishers_exac_pvalue</code>として得られる。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">grab_significance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">unit_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pre_mspe</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">post_mspe</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mspe_ratio</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rank</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">fishers_exact_pvalue</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z_score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">New Mexico</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.6187232</td>
<td style="text-align: right;">3.520239</td>
<td style="text-align: right;">5.689521</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0256410</td>
<td style="text-align: right;">4.5340434</td>
</tr>
<tr class="even">
<td style="text-align: left;">Maine</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.5947365</td>
<td style="text-align: right;">1.670436</td>
<td style="text-align: right;">2.808699</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.0512821</td>
<td style="text-align: right;">1.5525712</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Wisconsin</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.5834910</td>
<td style="text-align: right;">1.563416</td>
<td style="text-align: right;">2.679417</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.0769231</td>
<td style="text-align: right;">1.4187727</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ohio</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.8438535</td>
<td style="text-align: right;">2.164614</td>
<td style="text-align: right;">2.565154</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0.1025641</td>
<td style="text-align: right;">1.3005173</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Vermont</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.5580264</td>
<td style="text-align: right;">1.338843</td>
<td style="text-align: right;">2.399247</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.1282051</td>
<td style="text-align: right;">1.1288134</td>
</tr>
<tr class="even">
<td style="text-align: left;">California</td>
<td style="text-align: left;">Treated</td>
<td style="text-align: right;">0.6267683</td>
<td style="text-align: right;">1.432582</td>
<td style="text-align: right;">2.285664</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0.1538462</td>
<td style="text-align: right;">1.0112624</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mississippi</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">2.0235407</td>
<td style="text-align: right;">3.908860</td>
<td style="text-align: right;">1.931693</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.1794872</td>
<td style="text-align: right;">0.6449247</td>
</tr>
<tr class="even">
<td style="text-align: left;">Texas</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">1.5215707</td>
<td style="text-align: right;">2.776115</td>
<td style="text-align: right;">1.824506</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.2051282</td>
<td style="text-align: right;">0.5339924</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Nebraska</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">1.1685162</td>
<td style="text-align: right;">1.842674</td>
<td style="text-align: right;">1.576935</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.2307692</td>
<td style="text-align: right;">0.2777719</td>
</tr>
<tr class="even">
<td style="text-align: left;">Arkansas</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">1.4714305</td>
<td style="text-align: right;">2.305012</td>
<td style="text-align: right;">1.566511</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.2564103</td>
<td style="text-align: right;">0.2669838</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>6番目に大きい<code>California</code>のp_valueは<code>0.1538</code>で、処置効果があるとは言えない結果となっている。</p>
<p>以上の手続きを関数化したもの↓</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect_check <span class="ot">&lt;-</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  CausalInferenceTextbook<span class="sc">::</span><span class="fu">call_synthetic_control</span>(</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> smoking_fake_factor_no_effect,</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_treated =</span> name_treated,</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_start =</span> year_start,</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_income_age =</span> window_income_age,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_beer =</span> window_beer,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale1 =</span> window_cigsale1,</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale2 =</span> window_cigsale2,</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale3 =</span> window_cigsale3,</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">margin_ipop =</span> margin_ipop,</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigf_ipop =</span> sigf_ipop,</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">bound_ipop =</span> bound_ipop</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>推定結果の一致を確認。</p>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect_check <span class="sc">%&gt;%</span> </span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">grab_balance_table</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">variable</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">California</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">synthetic_California</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">donor_sample</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ln_income</td>
<td style="text-align: right;">10.0765586</td>
<td style="text-align: right;">9.9507206</td>
<td style="text-align: right;">9.8291968</td>
</tr>
<tr class="even">
<td style="text-align: left;">youth</td>
<td style="text-align: right;">0.1735324</td>
<td style="text-align: right;">0.1730182</td>
<td style="text-align: right;">0.1725101</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beer_sales</td>
<td style="text-align: right;">24.2800003</td>
<td style="text-align: right;">28.5184480</td>
<td style="text-align: right;">23.6552632</td>
</tr>
<tr class="even">
<td style="text-align: left;">cigsale_1</td>
<td style="text-align: right;">137.8555014</td>
<td style="text-align: right;">138.5129916</td>
<td style="text-align: right;">140.0848534</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cigsale_2</td>
<td style="text-align: right;">135.9694223</td>
<td style="text-align: right;">135.8295657</td>
<td style="text-align: right;">136.4325736</td>
</tr>
<tr class="even">
<td style="text-align: left;">cigsale_3</td>
<td style="text-align: right;">135.6485199</td>
<td style="text-align: right;">136.0652810</td>
<td style="text-align: right;">135.9853657</td>
</tr>
</tbody>
</table>


</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>smoking_out_factor_noeffect_check <span class="sc">%&gt;%</span> </span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">grab_significance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">unit_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pre_mspe</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">post_mspe</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mspe_ratio</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rank</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">fishers_exact_pvalue</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z_score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">New Mexico</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.6187232</td>
<td style="text-align: right;">3.520239</td>
<td style="text-align: right;">5.689521</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0256410</td>
<td style="text-align: right;">4.5340434</td>
</tr>
<tr class="even">
<td style="text-align: left;">Maine</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.5947365</td>
<td style="text-align: right;">1.670436</td>
<td style="text-align: right;">2.808699</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.0512821</td>
<td style="text-align: right;">1.5525712</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Wisconsin</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.5834910</td>
<td style="text-align: right;">1.563416</td>
<td style="text-align: right;">2.679417</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.0769231</td>
<td style="text-align: right;">1.4187727</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ohio</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.8438535</td>
<td style="text-align: right;">2.164614</td>
<td style="text-align: right;">2.565154</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0.1025641</td>
<td style="text-align: right;">1.3005173</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Vermont</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.5580264</td>
<td style="text-align: right;">1.338843</td>
<td style="text-align: right;">2.399247</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.1282051</td>
<td style="text-align: right;">1.1288134</td>
</tr>
<tr class="even">
<td style="text-align: left;">California</td>
<td style="text-align: left;">Treated</td>
<td style="text-align: right;">0.6267683</td>
<td style="text-align: right;">1.432582</td>
<td style="text-align: right;">2.285664</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0.1538462</td>
<td style="text-align: right;">1.0112624</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mississippi</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">2.0235407</td>
<td style="text-align: right;">3.908860</td>
<td style="text-align: right;">1.931693</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.1794872</td>
<td style="text-align: right;">0.6449247</td>
</tr>
<tr class="even">
<td style="text-align: left;">Texas</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">1.5215707</td>
<td style="text-align: right;">2.776115</td>
<td style="text-align: right;">1.824506</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.2051282</td>
<td style="text-align: right;">0.5339924</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Nebraska</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">1.1685162</td>
<td style="text-align: right;">1.842674</td>
<td style="text-align: right;">1.576935</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.2307692</td>
<td style="text-align: right;">0.2777719</td>
</tr>
<tr class="even">
<td style="text-align: left;">Arkansas</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">1.4714305</td>
<td style="text-align: right;">2.305012</td>
<td style="text-align: right;">1.566511</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.2564103</td>
<td style="text-align: right;">0.2669838</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
</section>
<section id="ファクターモデル処置効果があるケース" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="ファクターモデル処置効果があるケース"><span class="header-section-number">2.2.2</span> ファクターモデル：処置効果があるケース</h3>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>smoking_out_some_effect <span class="ot">&lt;-</span> </span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  CausalInferenceTextbook<span class="sc">::</span><span class="fu">call_synthetic_control</span>(</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> smoking_fake_factor_some_effect,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_treated =</span> name_treated,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_start =</span> year_start,</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_income_age =</span> window_income_age,</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_beer =</span> window_beer,</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale1 =</span> window_cigsale1,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale2 =</span> window_cigsale2,</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale3 =</span> window_cigsale3,</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">margin_ipop =</span> margin_ipop,</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigf_ipop =</span> sigf_ipop,</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">bound_ipop =</span> bound_ipop</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>smoking_out_some_effect <span class="sc">%&gt;%</span> </span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_trends</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-57-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>smoking_out_some_effect <span class="sc">%&gt;%</span> </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_placebos</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-58-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>smoking_out_some_effect <span class="sc">%&gt;%</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_mspe_ratio</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-59-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>smoking_out_some_effect <span class="sc">%&gt;%</span> </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">grab_significance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">unit_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pre_mspe</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">post_mspe</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mspe_ratio</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rank</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">fishers_exact_pvalue</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z_score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">California</td>
<td style="text-align: left;">Treated</td>
<td style="text-align: right;">1.4334040</td>
<td style="text-align: right;">143.054243</td>
<td style="text-align: right;">99.800368</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0256410</td>
<td style="text-align: right;">5.7555262</td>
</tr>
<tr class="even">
<td style="text-align: left;">Connecticut</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">2.7982138</td>
<td style="text-align: right;">96.288747</td>
<td style="text-align: right;">34.410789</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.0512821</td>
<td style="text-align: right;">1.8026246</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Wyoming</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.6725591</td>
<td style="text-align: right;">3.186678</td>
<td style="text-align: right;">4.738139</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.0769231</td>
<td style="text-align: right;">0.0088667</td>
</tr>
<tr class="even">
<td style="text-align: left;">Texas</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.6423494</td>
<td style="text-align: right;">1.746848</td>
<td style="text-align: right;">2.719467</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0.1025641</td>
<td style="text-align: right;">-0.1131651</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Delaware</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">1.9539715</td>
<td style="text-align: right;">3.948555</td>
<td style="text-align: right;">2.020785</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.1282051</td>
<td style="text-align: right;">-0.1554015</td>
</tr>
<tr class="even">
<td style="text-align: left;">Missouri</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">1.5299024</td>
<td style="text-align: right;">2.926263</td>
<td style="text-align: right;">1.912712</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0.1538462</td>
<td style="text-align: right;">-0.1619347</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Iowa</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">1.4943709</td>
<td style="text-align: right;">2.836098</td>
<td style="text-align: right;">1.897854</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.1794872</td>
<td style="text-align: right;">-0.1628329</td>
</tr>
<tr class="even">
<td style="text-align: left;">South Carolina</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">2.0733659</td>
<td style="text-align: right;">3.726453</td>
<td style="text-align: right;">1.797296</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.2051282</td>
<td style="text-align: right;">-0.1689118</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Oklahoma</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">0.8766306</td>
<td style="text-align: right;">1.555503</td>
<td style="text-align: right;">1.774411</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.2307692</td>
<td style="text-align: right;">-0.1702952</td>
</tr>
<tr class="even">
<td style="text-align: left;">South Dakota</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">1.5629471</td>
<td style="text-align: right;">2.540791</td>
<td style="text-align: right;">1.625641</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.2564103</td>
<td style="text-align: right;">-0.1792886</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
</section>
<section id="自己回帰モデルでの挙動処置効果がないケース" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="自己回帰モデルでの挙動処置効果がないケース"><span class="header-section-number">2.2.3</span> 自己回帰モデルでの挙動：処置効果がないケース</h3>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>smoking_out_ar_noeffect <span class="ot">&lt;-</span> </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>    CausalInferenceTextbook<span class="sc">::</span><span class="fu">call_synthetic_control</span>(</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> smoking_fake_ar_no_effect,</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_treated =</span> name_treated,</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_start =</span> year_start,</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_income_age =</span> window_income_age,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_beer =</span> window_beer,</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale1 =</span> window_cigsale1,</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale2 =</span> window_cigsale2,</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale3 =</span> window_cigsale3,</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">margin_ipop =</span> margin_ipop,</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigf_ipop =</span> sigf_ipop,</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">bound_ipop =</span> bound_ipop</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>smoking_out_ar_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_trends</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-62-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>smoking_out_ar_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_placebos</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-63-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>smoking_out_ar_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_mspe_ratio</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-64-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>smoking_out_ar_noeffect <span class="sc">%&gt;%</span> </span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">grab_significance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">unit_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pre_mspe</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">post_mspe</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mspe_ratio</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rank</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">fishers_exact_pvalue</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z_score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Kansas</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">3.780183</td>
<td style="text-align: right;">15.656657</td>
<td style="text-align: right;">4.1417726</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0256410</td>
<td style="text-align: right;">4.1753404</td>
</tr>
<tr class="even">
<td style="text-align: left;">West Virginia</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">9.596066</td>
<td style="text-align: right;">25.520837</td>
<td style="text-align: right;">2.6595104</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.0512821</td>
<td style="text-align: right;">2.3714579</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Illinois</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">8.323906</td>
<td style="text-align: right;">19.351049</td>
<td style="text-align: right;">2.3247559</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.0769231</td>
<td style="text-align: right;">1.9640685</td>
</tr>
<tr class="even">
<td style="text-align: left;">Tennessee</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">16.603856</td>
<td style="text-align: right;">26.226590</td>
<td style="text-align: right;">1.5795481</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0.1025641</td>
<td style="text-align: right;">1.0571661</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Virginia</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">11.399555</td>
<td style="text-align: right;">14.305395</td>
<td style="text-align: right;">1.2549082</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.1282051</td>
<td style="text-align: right;">0.6620860</td>
</tr>
<tr class="even">
<td style="text-align: left;">California</td>
<td style="text-align: left;">Treated</td>
<td style="text-align: right;">6.602983</td>
<td style="text-align: right;">8.284861</td>
<td style="text-align: right;">1.2547149</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0.1538462</td>
<td style="text-align: right;">0.6618507</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Georgia</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">9.795919</td>
<td style="text-align: right;">11.062974</td>
<td style="text-align: right;">1.1293453</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.1794872</td>
<td style="text-align: right;">0.5092785</td>
</tr>
<tr class="even">
<td style="text-align: left;">Louisiana</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">8.517692</td>
<td style="text-align: right;">9.190666</td>
<td style="text-align: right;">1.0790089</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.2051282</td>
<td style="text-align: right;">0.4480201</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Arkansas</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">16.971218</td>
<td style="text-align: right;">15.502556</td>
<td style="text-align: right;">0.9134616</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.2307692</td>
<td style="text-align: right;">0.2465524</td>
</tr>
<tr class="even">
<td style="text-align: left;">Missouri</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">10.405400</td>
<td style="text-align: right;">9.258251</td>
<td style="text-align: right;">0.8897544</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.2564103</td>
<td style="text-align: right;">0.2177013</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
</section>
<section id="自己回帰モデルでの挙動処置効果があるケース" class="level3" data-number="2.2.4">
<h3 data-number="2.2.4" class="anchored" data-anchor-id="自己回帰モデルでの挙動処置効果があるケース"><span class="header-section-number">2.2.4</span> 自己回帰モデルでの挙動：処置効果があるケース</h3>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>smoking_out_ar_some_effect <span class="ot">&lt;-</span> </span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    CausalInferenceTextbook<span class="sc">::</span><span class="fu">call_synthetic_control</span>(</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> smoking_fake_ar_some_effect,</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">name_treated =</span> name_treated,</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_start =</span> year_start,</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_income_age =</span> window_income_age,</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_beer =</span> window_beer,</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale1 =</span> window_cigsale1,</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale2 =</span> window_cigsale2,</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">window_cigsale3 =</span> window_cigsale3,</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">margin_ipop =</span> margin_ipop,</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sigf_ipop =</span> sigf_ipop,</span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">bound_ipop =</span> bound_ipop</span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>smoking_out_ar_some_effect <span class="sc">%&gt;%</span> </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_trends</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>smoking_out_ar_some_effect <span class="sc">%&gt;%</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_placebos</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-68-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>smoking_out_ar_some_effect <span class="sc">%&gt;%</span> </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">plot_mspe_ratio</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="第9章_files/figure-html/unnamed-chunk-69-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<details open="" class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>smoking_out_ar_some_effect <span class="sc">%&gt;%</span> </span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>  tidysynth<span class="sc">::</span><span class="fu">grab_significance</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kbl</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">unit_name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">type</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">pre_mspe</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">post_mspe</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mspe_ratio</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">rank</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">fishers_exact_pvalue</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">z_score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">California</td>
<td style="text-align: left;">Treated</td>
<td style="text-align: right;">6.723326</td>
<td style="text-align: right;">242.99504</td>
<td style="text-align: right;">36.142089</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.0256410</td>
<td style="text-align: right;">5.6681645</td>
</tr>
<tr class="even">
<td style="text-align: left;">Kansas</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">9.104785</td>
<td style="text-align: right;">102.50484</td>
<td style="text-align: right;">11.258348</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.0512821</td>
<td style="text-align: right;">1.4996386</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Connecticut</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">10.101798</td>
<td style="text-align: right;">82.02365</td>
<td style="text-align: right;">8.119708</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.0769231</td>
<td style="text-align: right;">0.9738533</td>
</tr>
<tr class="even">
<td style="text-align: left;">Vermont</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">15.470557</td>
<td style="text-align: right;">62.86965</td>
<td style="text-align: right;">4.063826</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0.1025641</td>
<td style="text-align: right;">0.2944117</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Colorado</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">10.376025</td>
<td style="text-align: right;">31.57988</td>
<td style="text-align: right;">3.043543</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">0.1282051</td>
<td style="text-align: right;">0.1234939</td>
</tr>
<tr class="even">
<td style="text-align: left;">Texas</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">5.655715</td>
<td style="text-align: right;">14.81507</td>
<td style="text-align: right;">2.619486</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0.1538462</td>
<td style="text-align: right;">0.0524558</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Louisiana</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">10.620340</td>
<td style="text-align: right;">22.36307</td>
<td style="text-align: right;">2.105683</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0.1794872</td>
<td style="text-align: right;">-0.0336164</td>
</tr>
<tr class="even">
<td style="text-align: left;">Rhode Island</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">15.695695</td>
<td style="text-align: right;">32.05287</td>
<td style="text-align: right;">2.042144</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">0.2051282</td>
<td style="text-align: right;">-0.0442606</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Iowa</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">11.573409</td>
<td style="text-align: right;">21.04892</td>
<td style="text-align: right;">1.818731</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0.2307692</td>
<td style="text-align: right;">-0.0816866</td>
</tr>
<tr class="even">
<td style="text-align: left;">West Virginia</td>
<td style="text-align: left;">Donor</td>
<td style="text-align: right;">11.716885</td>
<td style="text-align: right;">20.41109</td>
<td style="text-align: right;">1.742023</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">0.2564103</td>
<td style="text-align: right;">-0.0945368</td>
</tr>
</tbody>
</table>


</div>
</div>
<p><br></p>
<p><strong>引用元コピーライト表示</strong></p>
<p>MIT License Copyright (c) 2020 Eric Dunford</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>
</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>